/**
 * 币圈生涯模拟器 - 主逻辑
 * 闲置自动模拟，时间流逝 + 事件驱动，多路径资源与结局
 */

/** 币圈路径：开局选一条，整局只走这一条。每条路径有专属事件与结局。 */
const PATHS = [
  { id: 'kol', name: 'KOL博主', icon: '🎤' },
  { id: 'job', name: '项目打工', icon: '💼' },
  { id: 'trading', name: '炒币', icon: '📈' },
  { id: 'launch', name: '发币/撸土狗', icon: '🪙' },
  { id: 'invest', name: '投项目', icon: '💰' },
  { id: 'staking', name: '质押/DeFi躺赚', icon: '🛏️' },
  { id: 'airdrop', name: '撸空投', icon: '🎁' },
];
/** 开局第一条日志：路径选择叙事 */
const PATH_FIRST_LOG = {
  kol: '初入币圈，你决定做 KOL：写推、涨粉、接广告。',
  job: '初入币圈，你决定进项目打工：领工资、拿代币、跟项目共沉浮。',
  trading: '初入币圈，你决定专心炒币：做多、做空、跟单、冲梗币。',
  launch: '初入币圈，你决定自己发币/撸土狗：建社区、拉盘、吃税费。',
  invest: '初入币圈，你决定投项目：早期埋伏、等上所、吃分红。',
  staking: '初入币圈，你决定质押躺赚：跑节点、做流动性、挖矿。',
  airdrop: '初入币圈，你决定撸空投：多链交互、领大毛、防女巫。',
};

const CAPITAL_MIN = 100;           // 仅用于结局判定档位，不再因低于此结束游戏
const A10 = 1e10;                  // A10 = 100亿 U，达到即提前胜利结束
const MAX_YEARS = 5;               // 五年到点结账
// 负债游戏中不再计息/还贷，只在借钱或亏损转债时增加；结算时自动还清负债，按净资产算资产
const WEALTH_FREE = 10_000_000;    // 结局档位用（大成线）
const PASSIVE_INCOME_FREE = 50000; // 结局档位用
const TICKS_PER_YEAR = 12;        // 1年 = 12月，减少事件密度、拉大每局差异
const MS_PER_TICK = 2000;         // 每 tick 默认 2 秒（1 月）
const MAX_LOSS_PCT = 0.45;          // 单次事件最大亏损比例（平衡亏钱与体验）

const MARKET_PHASES = ['bull', 'sideway', 'bear'];
const MARKET_DURATION_MIN = 3;    // 市场相位最少持续月数
const MARKET_DURATION_MAX = 14;

/** 0.5% 暴雷事件池：资产降低 80%～150%，随机展示不同叙事 */
const CATASTROPHE_EVENTS = [
  { name: '黑天鹅暴雷', logTemplate: '遭遇黑天鹅，资产蒸发一大截，损失 {loss} U。' },
  { name: '交易所暴雷', logTemplate: '常驻的交易所突然暴雷，资产大半无法提现，损失 {loss} U。' },
  { name: '跨链桥被黑', logTemplate: '跨链桥遭黑客攻击，你卡在桥上的资产几乎全没，损失 {loss} U。' },
  { name: '私钥/助记词泄露', logTemplate: '私钥或助记词泄露，钱包被搬空，损失 {loss} U。' },
  { name: '合约漏洞被掏空', logTemplate: '参与的 DeFi 合约被 exploit，池子被掏空，损失 {loss} U。' },
  { name: '项目方 Rug', logTemplate: '重仓项目方直接 Rug，流动性抽干，损失 {loss} U。' },
  { name: '监管冻结/罚没', logTemplate: '监管出手，部分资产被冻结或罚没，损失 {loss} U。' },
  { name: '连环爆仓', logTemplate: '行情极端波动，杠杆仓位连环爆仓，损失 {loss} U。' },
  { name: '假客服/仿冒骗走大额', logTemplate: '被假客服或仿冒账号骗走大额资产，损失 {loss} U。' },
  { name: '恶意授权未撤销', logTemplate: '早年授权的恶意合约一直没撤，被一次性划走，损失 {loss} U。' },
  { name: '内幕消息是局', logTemplate: '信了「内幕」重仓，结果全是局，损失 {loss} U。' },
  { name: '钱包/设备丢失', logTemplate: '存助记词的设备或冷钱包丢失，资产无法找回，损失 {loss} U。' },
];

/** 人生结局：最终过上了什么样的生活（见 人生结局设计.md）. 约90%现实类，10%其他类。 */
const LIFE_ENDINGS = {
  // ----- 极惨/悲剧 -----
  beggar: { title: '流落街头', desc: '本金亏光后无处可去，在桥洞下讨饭。', class: 'tragic', story: '币圈梦碎之后，你再也付不起房租。先是网吧过夜，后来连网吧都去不起，你住进了城市边缘的桥洞。每天蹲在路口举着纸牌，偶尔有人扔几个钢镚。夜里你望着手机里早已归零的持仓截图，想起当年「梭哈致富」的豪言，苦笑一声，把破毯子裹紧。' },
  debt_suicide: { title: '负债跳楼', desc: '欠了一屁股债还不上，某天夜里走上天台。', class: 'tragic', story: '你亏完了所有的钱，甚至连父母给你买房的钱都亏完了。催债的电话和短信再也没有停过，家里砸锅卖铁也填不上窟窿。那天夜里你走上天台，风好大，你安慰自己，一会儿就不冷了。你回头看了一眼家的方向，一跃而下，给家人留下了一屁股债和永远无法愈合的伤口。' },
  debt_fugitive: { title: '被追杀跑路', desc: '欠了不该欠的人，隐姓埋名躲去小县城。', class: 'tragic', story: '你借了不该借的人的钱去抄底，结果爆仓归零。对方不是银行，不会跟你讲法律。你连夜买了去偏远小县城的车票，换了手机卡，再也不敢用真名。从此你活在阴影里，每逢过年看到别人团圆，你只能躲在出租屋里啃泡面，心里清楚：这辈子怕是回不去了。' },
  jail: { title: '进局子', desc: '涉嫌诈骗/非法集资，牢底坐穿。', class: 'tragic', story: '为了翻本你搞了「社区代投」，钱收了不少，项目却一个接一个跑路。终于有人报了警。庭审那天，你站在被告席上，听着检察官一条条念，才意识到自己早已越界。链上还有你的传说，只不过都成了警示案例。出狱那天，已是多年以后，世界早已变了模样。' },
  mental_collapse: { title: '精神崩溃', desc: '亏到魔怔，住进精神病院。', class: 'tragic', story: '爆仓的那一晚你盯着K线看了通宵，从此再也没能走出来。你总说「会涨的」「抄底」「拿住」，见人就讲你的仓位和信仰。家人把你送进医院，你坐在病房里依然对着窗户比划K线。护士叹气说，又一个币圈来的。你早已分不清现实和盘面，在无尽的横盘与幻想里度过了余生。' },
  betrayed_all: { title: '众叛亲离', desc: '骗了亲友的钱全亏光，没人再信你。', class: 'tragic', story: '当初你拍着胸脯跟亲戚朋友说稳赚，他们把买房款、养老钱都交给了你。归零之后，你再也没脸见人。过年不敢回家，电话不敢接，同学聚会永远缺席。听说母亲因为你气病了，父亲在亲戚面前抬不起头。你躲在一个没人认识的城市，用假名打工，余生都在还债与愧疚中度过。' },
  pig_butchering: { title: '一生黑历史', desc: '被杀猪盘骗光感情和钱。', class: 'tragic', story: '你在网上认识了一个人，聊投资、聊未来、聊感情，对方带你「一起赚钱」。等你把全部身家转进那个平台，发现再也提不出来，那个人也消失了。你报了警，却石沉大海。从此一提投资你就发抖，再也不敢信任何人。那段日子成了你心里永远的黑洞。' },
  destitute: { title: '贫困潦倒', desc: '投资失败，负债累累，老年流浪街头。', class: 'tragic', story: '年轻时你all in 过无数次，起落落落，最后落得一身债。没有社保，没有积蓄，儿女也和你断了联系。老了以后你只能露宿街头，靠捡瓶子和救济站过活。某个冬夜，你蜷在立交桥下，想起曾经账户里的数字和「财富自由」的梦，像上辈子的事。' },
  die_alone: { title: '孤独终老', desc: '一生单身，晚年无人陪伴。', class: 'tragic', story: '你把最好的年华都献给了盯盘和社区，没时间恋爱，也没心思成家。等你想安定下来，已经没人愿意靠近一个满嘴K线、负债累累的人。晚年你独自住在一间小公寓里，某天倒在门口，几天后才被邻居发现。葬礼上没有人哭，只有社工按流程把你送走。' },
  sudden_death: { title: '意外早逝', desc: '车祸突然夺走生命。', class: 'tragic', story: '那天你刚在车上看了眼行情，心想再撑一阵就能回本。红灯亮起时你踩下刹车，却被后车狠狠追尾。再醒来时你已经飘在半空，看着救护车和围观的群众。你还有那么多没平掉的仓、没还完的债、没见最后一面的人——但一切都已经来不及了。' },
  cancer_fight: { title: '癌症抗争', desc: '与病魔搏斗多年，最终败北。', class: 'tragic', story: '查出病的那年，你刚把最后一笔钱投进一个「百倍项目」。化疗花光了借来的钱，项目却跑路了。你在病床上刷着维权群，苦笑：原来人生和币圈一样，都是庄家说了算。弥留之际，你握着家人的手说，别再碰那些了。他们点头，泪流满面。' },
  homeless_freeze: { title: '流浪汉冻死街头', desc: '无家可归，某个冬天冻死在桥洞下。', class: 'tragic', story: '亏光之后你流落街头，夏天还能撑，冬天却一天比一天难熬。那晚特别冷，你把能找到的纸箱和破布全裹在身上，还是止不住发抖。你想起曾经在暖气房里喝着咖啡看盘的日子，像一场梦。天亮时，有人发现你已经没了呼吸，手里还攥着一张皱巴巴的交易所小票。' },
  gambling_ruin: { title: '痴迷赌博倾家荡产', desc: '赌到倾家荡产，妻离子散。', class: 'tragic', story: '炒币和赌博在你心里早就没了边界。你越亏越梭哈，越梭哈越亏，房子卖了，老婆带着孩子走了，父母和你断绝关系。最后你倒在赌场门口，手里攥着最后几枚筹码。路人绕道而行，没人知道你曾经也有过家，有过梦。' },
  abuse_depression: { title: '被家暴一生抑郁', desc: '长期被伴侣虐待，抑郁成疾。', class: 'tragic', story: '亏钱之后你在家里越来越没地位，伴侣的拳头和冷嘲热讽成了日常。你想过离开，却发现自己连路费都凑不齐。你变得越来越沉默，最后被诊断出重度抑郁。很多个夜晚你站在窗边，想着要不要跳下去，却连推开窗户的力气都没有。' },
  journalist_killed: { title: '记者揭黑而被害', desc: '调查黑幕触怒利益集团。', class: 'tragic', story: '离开币圈后你转行做调查记者，盯上了某个前圈内项目的资金盘和实控人。证据越挖越多，稿子写了一半就收到「别多管闲事」的警告。你没停笔。某天夜里你在回家路上被无牌车撞飞，警方定性为交通事故。你的报道没有发出，真相和你一起被埋进土里。' },
  climber_missing: { title: '冒险家攀登珠峰失踪', desc: '登顶途中失联，永远留在雪山上。', class: 'tragic', story: '币圈梦碎后你想换个活法，报名了珠峰商业登山。冲顶那天天气突变，你和队伍失联。对讲机里最后一句是「我能看见顶了」。搜救队只找到你的一只手套。你永远留在那片雪白里，再也不用面对K线和债务。' },
  programmer_burnout: { title: '程序员996猝死', desc: '长期加班，某天倒在工位上。', class: 'tragic', story: '亏钱之后你只能拼命接活还债，996成了常态。那天凌晨你还在改需求，心想做完这单就能还掉一笔。忽然眼前一黑，你再也没醒过来。同事发现你时，屏幕还停在交易所页面。你的遗物里有一张纸条：等牛市来了，记得帮我清仓。' },
  travel_blogger_death: { title: '旅行博主死于冒险', desc: '为流量去危险地带，一次失手再没回来。', class: 'tragic', story: '为了涨粉接广告，你去了越来越危险的地方。那次在悬崖边拍「币圈自由人生」时，脚下一滑。镜头记录了你最后的尖叫和坠落的天空。评论区有人说 RIP，有人说炒作翻车。没人知道你是为了还债才这么拼。' },
  musician_depression: { title: '音乐家巅峰后抑郁', desc: '红极一时后过气，抑郁多年。', class: 'tragic', story: '你曾靠一首歌火遍全网，赚到的钱全投进了币圈，想「钱生钱」。后来歌过气了，币也归零了。你再也写不出东西，每天躲在房间里不见人。某个深夜你弹完最后一曲，走向了阳台。你的歌还在播放器里被循环，而你已不再需要掌声。' },
  alcohol_early_death: { title: '酗酒毁健康早逝', desc: '借酒浇愁，肝坏了。', class: 'tragic', story: '爆仓之后你开始酗酒，从每晚一瓶到从早喝到晚。家人劝你戒，你说戒了更难受。几年后你查出肝硬化，医生说晚了。临终前你盯着天花板，想起没亏之前的日子，像隔了一辈子。酒瓶还立在床头，再也没人替你收。' },
  dementia_forgotten: { title: '痴呆晚年被遗忘', desc: '得了阿尔茨海默，谁也不认识。', class: 'tragic', story: '币圈那几年你记过无数个代码、白皮书、路线图。老了却连自己儿女的名字都叫不出。你总嘟囔着一串数字，护工说那是你当年的钱包地址。你坐在养老院走廊里望着窗外，偶尔笑一下，没人知道你在想什么。也许是你曾拥有过的那一串零。' },
  politician_jail: { title: '政客腐败入狱而终', desc: '贪腐落马，牢里待了十几年。', class: 'tragic', story: '离开币圈后你进了体制，位高权重时经手的项目与资金数不胜数，也从中捞了不少——链上的习惯带到了线下。东窗事发后，你在法庭上听着对自己的指控，一条条对得上记录。你在监狱里度过十几年，出狱时满头白发，曾经的圈子早已没人认得你。' },
  divorce_lonely: { title: '离婚多次孤独', desc: '离了几次婚，晚年无人探望。', class: 'tragic', story: '币圈那几年每一段婚姻都毁在你的执念上——要么亏钱吵翻天，要么有钱了膨胀到对方无法忍受。离场后孩子跟了前任，渐渐不再联系。晚年你住在养老院，过节时看着别人被接走，你的床位前从没有人来。你才明白，有些东西比财富更难挽回。' },
  unfilial_nursing_home: { title: '子女不孝孤独院', desc: '儿女不闻不问，在养老院孤独离世。', class: 'tragic', story: '当年你沉迷炒币，没管过孩子学习，也没给过他们安全感。离场时你已一无所有。他们长大后背井离乡，很少回来。你住进养老院后，他们只在过年时打一通电话。最后那天你握着护士的手说想见孩子一面。他们赶到时，你已经闭上了眼睛。' },
  misdiagnosis: { title: '被误诊错过治疗', desc: '小病被误诊，拖成绝症。', class: 'tragic', story: '币圈那几年你总觉得身体有点不对劲，但正赶上一波行情，你没空去医院。离场后查出来已经晚期，医生摇头说早半年还有希望。你躺在病床上算着医疗费和自己所剩无几的存款，苦笑：在币圈算过那么多账，却没算过自己的命。' },
  stroke_collapse: { title: '突然中风倒下', desc: '某天突然中风，卧床多年。', class: 'tragic', story: '那天你正在盯盘，忽然半边身子不能动了。救护车把你送进医院，命保住了，却再也站不起来。币圈离场后你躺在床上靠子女轮流照顾，偶尔用还能动的那只手划一划手机。你不再说话，不知道是说不出口，还是无话可说。' },
  heart_attack: { title: '突然心脏病', desc: '毫无预兆心梗，倒在饭桌上。', class: 'tragic', story: '币圈离场后那顿饭你和家人难得聚齐，正聊着以后的打算，你忽然捂住胸口倒了下去。急救车赶到时已经来不及。后来家人在你手机里发现满屏的行情和杠杆提醒。他们才明白，你从来没有真正轻松过。' },
  eco_hero: { title: '环保斗士改变世界后离去', desc: '推动立法、改变行业，累垮了身体。', class: 'tragic', story: '离开币圈时你带着第一桶金转投环保，四处奔走、推动立法、对抗大公司。你赢了太多场仗，却输给了自己的身体。临终前你躺在病床上，看着新闻里播报你推动通过的法案，笑了笑。有人问你后悔吗，你说，只后悔没早点离开那个盘面。' },
  war_survivor: { title: '战争幸存者创伤一生', desc: '从战乱中活下来，PTSD伴随一生。', class: 'tragic', story: '你在战乱中失去家人和家园，带着仅剩的一点钱逃到异国，误打误撞进了币圈。离场时你依旧一无所有。你活下来了，却每晚被噩梦惊醒——有时是炮火，有时是爆仓。晚年你在疗养院里，偶尔会突然抱头蹲下。护士说，那是又「回到那边」了。' },
  parent_sacrifice: { title: '父母为孩子牺牲一切', desc: '把一切给了孩子，自己省吃俭用。', class: 'tragic', story: '币圈那几年你赚过也亏过，离场时所剩无几。之后你一辈子没为自己活，每一分钱都给了孩子读书、买房、创业。自己生病舍不得看，吃饭凑合。孩子出息了却很少回来。你走的时候很安详，心想他们过得好就好。葬礼上他们哭得很伤心，你再也听不见。' },
  athlete_disabled: { title: '运动员伤残退役', desc: '重伤退役，赔偿金花完，晚景凄凉。', class: 'tragic', story: '你在赛场上重伤终结职业生涯，赔偿金本可安稳度日，你却听信人言全部投进「稳赚」的币圈项目。爆雷之后你一无所有，腿脚又不便，只能靠低保过活。你常盯着电视里的比赛回放，那是人生最辉煌的瞬间，却再也不会重来。' },
  artist_posthumous: { title: '艺术家穷困而死却后世成名', desc: '生前穷困潦倒，死后作品天价。', class: 'tragic', story: '你一生坚持创作却从未被市场认可。为了活下去你也曾进币圈想赚点钱，亏得精光。你在狭小阁楼里去世，身边只有未完成的作品。多年后有人发现你的画，拍卖行拍出天价。评论家说你是被时代忽略的天才。可你早已化作尘土，一分钱也花不到。' },
  writer_hermit: { title: '作家畅销书后隐居', desc: '写过爆款后再也写不出，隐居避世。', class: 'tragic', story: '你曾写畅销书，版税和名气让你飘飘然，把钱投进币圈想「放大」。崩盘之后你再也写不出东西，读者骂你江郎才尽。你躲到乡下，不接电话不见人，每天对着空白文档发呆。临终前你烧掉所有未完成的手稿，说，留着一个写不出字的人的名字，没意思。' },
  // ----- 惨但活着 -----
  bankruptcy: { title: '破产归零', desc: '币圈轮回，重开学费。本金耗尽，灰溜溜离场。', class: 'bad', story: '最后一笔仓位爆掉的时候，你盯着归零的账户看了很久。没有哭，也没有闹，只是默默关了软件，卸载了所有交易所和钱包。你走出网吧，阳光刺眼。你知道自己又交了一笔学费，只是这次贵得有点离谱。你深吸一口气，告诉自己：从头再来吧，反正也没啥可再输的了。' },
  wage_slave_debt: { title: '打工人还债', desc: '亏光后老实上班，还债还了十年。', class: 'bad', story: '亏光之后你删掉了所有币圈群，找了一份朝九晚五的工作。每个月工资到账，先还债，剩下的刚够吃饭。同事聊股票聊基金，你从不插嘴。十年后最后一笔债还清那天，你一个人去吃了一顿好的，没有庆祝，只是觉得终于可以喘口气了。你再也没碰过任何「高收益」的东西。' },
  back_to_farm: { title: '回老家种地', desc: '币圈梦碎，回村务农。', class: 'bad', story: '城市待不下去了，你拖着行李箱回到老家。父母没多问，给你腾了间房。你跟着下地，手上磨出了茧子，心里反而踏实了。手机里还存着当年的K线截图，你偶尔翻出来看看，像看别人的故事。村里人问你城里混得咋样，你笑着说，混不动了，回来种地。' },
  quit_forever: { title: '戒断韭菜', desc: '亏怕了，卸载所有交易所和钱包。', class: 'bad', story: '那天晚上你删掉了所有交易所APP、钱包、行情软件，退掉了所有群。手机一下子安静了。你躺在床上想，要是早一点收手该多好。可世上没有要是。从此你绝口不提币圈，有人聊你也只是笑笑。你知道自己戒的不是币，是那个总想一夜暴富的自己。' },
  small_loss_exit: { title: '小亏离场', desc: '赔了一点及时收手，当交学费。', class: 'bad', story: '你亏了一笔，不多不少，刚好肉疼但不致命。你冷静下来算了算，要是再玩下去，可能真的会倾家荡产。于是你提现了剩下的钱，卸载了软件。朋友问你咋不玩了，你说交够学费了，该毕业了。后来你偶尔还会想起那段日子，但再也没有回去过。' },
  // ----- 普通/路人 -----
  nobody: { title: '币圈路人甲', desc: '小赚小亏混完几年，没暴富也没归零。', class: 'normal', story: '你在币圈混了几年，赚过也亏过，最后算下来不痛不痒。没有暴富的传说，也没有归零的惨剧，你就是那种在群里从不发言、持仓永远不敢梭哈的路人甲。离开的那天你退了群，没人注意到。你回归正常生活，偶尔在新闻里看到币圈消息，会心一笑，像在说：那几年，我也在。' },
  exit_ashore: { title: '及时止损上岸', desc: '套现一笔，买房买车。', class: 'normal', story: '你在相对高位套现了一笔，虽然没吃到最顶，但足够付首付了。你买了房买了车，把剩下的钱存进银行，再也不看行情。朋友还在群里晒收益，你只是默默潜水。有时你会想，要是多拿一会儿会不会更赚？但你更清楚，多少人就是死在这个「要是」上。你选择了上岸，从此币圈只是饭桌上的谈资。' },
  forget_hold: { title: '佛系持币', desc: '拿着一点币再也不看，多年后忘了助记词。', class: 'normal', story: '你买了一些币，然后真的「拿住」了——拿得忘了个干净。多年后大扫除时你翻出一张纸条，上面写着一串单词，你想了半天才想起来是助记词。你去查了查那个钱包，发现要么已经转不出来了，要么价值早就不值一提。你笑了笑，把纸条扔进碎纸机。有些东西，忘了就忘了吧。' },
  side_income: { title: '副业炒币', desc: '一直当副业玩玩，赚点零花钱。', class: 'normal', story: '你从没把炒币当主业，就是下班后看看行情，小仓位玩玩。赚了不加仓，亏了不梭哈，几年下来竟然还小有盈余。同事问你秘诀，你说没啥秘诀，别当真就行。你知道自己成不了大佬，也饿不死，这样挺好。币圈对你来说就是一个副业，和周末钓鱼没啥区别。' },
  lurker: { title: '万年潜水', desc: '混了多年群和推特，从不发言，只看不买。', class: 'normal', story: '你在无数个币圈群里潜了多年水，看尽了暴富神话和维权现场，自己却从没下过单。你像看戏一样看着别人起落，偶尔截图当笑话发给朋友。有人问你为啥不玩，你说看戏不花钱。最后你退群的时候，没人记得你存在过。你带着一肚子故事回归现实，深藏功与名。' },
  plain_life: { title: '平淡一生', desc: '朝九晚五，娶妻生子，普通却满足地老去。', class: 'normal', story: '你在币圈小玩过几年，没暴富也没爆仓，后来工作忙了就不怎么看了。你按部就班地结婚、买房、生孩子，偶尔在新闻里看到比特币又涨了，会跟老婆说一句「当年我也买过一点」。她笑你马后炮。你也不争辩。晚年你牵着孙子的手在公园散步，觉得这样平平淡淡，也挺好。' },
  worker_retirement_ok: { title: '普通上班族养老金刚够用', desc: '养老金不多不少，够看病够吃饭。', class: 'normal', story: '你一辈子没大富大贵，年轻时在币圈小打小闹，也没改变命运。退休后你领着养老金，不多不少，够吃饭够看病，偶尔还能给孙子包个红包。你坐在阳台上晒太阳，想起年轻时也曾幻想过财富自由，如今只觉得，能安稳老去，已经是一种福气。' },
  // ----- 小成/幸福 -----
  small_rich: { title: '小富即安', desc: '赚到几百万，买房买车收手。', class: 'good', story: '你在币圈赚到了几百万，没有贪心继续冲，而是果断套现。你买了房买了车，剩下的钱存起来吃利息。朋友问你为啥不继续玩，你说够了，再玩就是赌了。你辞掉了不喜欢的工作，找了一份清闲的活儿，每天睡到自然醒。回头想想，加入币圈或许是你人生最重要的决定之一——但及时离开，也是。' },
  passive_life: { title: '自由职业', desc: '被动收入够活，辞了工作。', class: 'good', story: '你的被动收入终于覆盖了日常开销。你递了辞呈，不再看老板脸色。你每天睡到自然醒，写写东西、接接咨询，剩下的时间全是自己的。有人问你财务自由的秘诀，你说不是自由，是选择——你选择了够用就停，而不是永远想要更多。' },
  kol_small: { title: '小KOL养老', desc: '粉丝不多但够接广告糊口。', class: 'good', story: '你的粉丝量不算顶流，但足够接广告、开Space、偶尔带货。你不再追求爆红，而是把这份影响力当成一份稳定的收入。你每天发几条推，回回评论，日子过得轻松自在。年轻人问你咋不冲了，你笑着说，冲过了，现在该养老了。' },
  early_retire: { title: '提前退休', desc: '四十岁不到就退休，靠利息和持币过日子。', class: 'good', story: '你在四十岁前攒够了被动收入，果断退休。有人骂你躺平，你只是笑笑。你每天读书、旅行、陪家人，再也不用在早高峰挤地铁。偶尔你还会看看行情，但再也不为涨跌心跳。你觉得自己最大的成功不是赚了多少钱，而是买回了自己的时间。' },
  angel_glory: { title: '天使投资人', desc: '投中几个小项目，在圈里小有名气。', class: 'good', story: '你早期押中了几个项目，虽然没百倍，但足够在圈里站稳脚跟。年轻人找你取经，你说运气和眼光各占一半。你不再亲自下场炒币，而是专注投人和看项目。某次峰会上有人介绍你为「老炮」，你举杯一笑，心里想，这一路跌跌撞撞，总算没白走。' },
  peaceful_old_age: { title: '安享天年', desc: '儿孙满堂，退休后环游世界。', class: 'good', story: '你退休后带着老伴环游世界，从北欧的极光到南美的雨林，从日本的樱花到非洲的草原。儿孙们偶尔视频问你到哪了，你笑着说在某某海边晒太阳。某天你在异国的小旅馆里安详离世，手里还攥着下一站的机票。你没有遗憾，因为该看的风景，都看过了。' },
  family_bliss: { title: '家庭美满', desc: '与爱人白头偕老，看着孙子长大。', class: 'good', story: '你从币圈赚到的钱没有挥霍，而是给了家人更好的生活。你和爱人白头偕老，看着孩子成家、孙子出生。晚年你坐在摇椅里，听孙子讲学校里的趣事，心里满是平静。你想起年轻时在电脑前盯盘的日子，觉得那些数字远不如眼前这张笑脸真实。' },
  travel_world: { title: '环游世界', desc: '退休后背包走遍全球。', class: 'good', story: '你离开了币圈，带着套现的钱开始环游世界。你见过冰岛的极光、撒哈拉的星空、京都的樱花、马丘比丘的云雾。你站在每一个风景前都会想：如果不是当年那个决定，我可能一辈子也看不到这些。最后你在海边的一座小城定居，每天看日落。临终前你回望这一生，觉得加入币圈，真是你人生最重要的决定之一。' },
  retire_after_peak: { title: '事业巅峰后隐退', desc: '功成身退，归隐田园。', class: 'good', story: '你在行业里做到了顶尖，然后主动选择了离开。没有人理解你为何在巅峰时收手，你说，见好就收才是智慧。你归隐田园，种菜养花，偶尔有老友来拜访，请你出山当顾问，你笑着拒绝。你觉得人生下半场，该换一种活法了。' },
  charity_remembered: { title: '公益一生被铭记', desc: '捐钱捐时间，死后被无数人怀念。', class: 'good', story: '你从币圈赚到的钱，很大一部分捐给了教育、医疗和环保。你不仅捐钱，还亲自去做志愿者。多年后你因病离世，葬礼上来了无数你帮助过的人。有人说你改变了他们的人生。你听不到了，但你的名字被刻在了一座希望小学的墙上，永远被铭记。' },
  mountain_hermit: { title: '山里隐居安度晚年', desc: '携家进山，含饴弄孙。', class: 'good', story: '你在合适的时机套现离场，带着家人进山隐居。你在山间含饴弄孙，偶尔种菜采茶，与世无争。你偶尔会想起当年链上的喧嚣与机会，但从不后悔。你在一个安静的午后离世，窗外是青山白云，心里是满满的平静。' },
  teacher_legacy: { title: '教师桃李满天下', desc: '教书育人一辈子。', class: 'good', story: '你曾靠币圈赚过一笔，却没有沉迷。你用那笔钱读了想读的书、考了想考的证，最后成了一名教师。你教了一辈子书，学生遍布各行各业。退休时他们从各地赶来为你庆贺。你站在讲台上说，谢谢你们，让我觉得这一生没有白活。' },
  farmer_land: { title: '农民守着田地终老', desc: '守着祖传几亩地，春种秋收。', class: 'good', story: '你在城里打拼过，也在币圈折腾过，最后回到老家继承了那几亩地。你春种秋收，不再看K线，只看天气和庄稼。邻居笑你城里混不下去才回来，你也不解释。你觉得脚踩在泥土里，比踩在云端踏实。你在一个丰收的秋天离世，谷仓里堆满了金黄的稻子。' },
  couple_70_same_day: { title: '夫妻相伴70年同日离', desc: '与老伴同日离世。', class: 'good', story: '你和老伴相伴七十年，从未分开。那天早上你们一起吃了早饭，下午她先走了，你握着她的手坐了一夜，天亮时也闭上了眼睛。儿女说这是福气，没人拆散你们。葬礼上他们把你俩合葬在一起，墓碑上刻着：同生共死，不负此生。' },
  scientist_nobel: { title: '科学家诺奖后低调', desc: '拿过诺奖后深居简出。', class: 'good', story: '离开币圈时你小有积蓄，全投回了实验室。你一生专注研究，后来拿了诺奖，却拒绝一切商业活动，深居简出。你最后是在实验室里走的，手里还拿着一份未完成的论文。有人说你是真正的学者，你说，只是把币圈那几年换成了该做的事。' },
  doctor_hero_death: { title: '医生救人无数自己病逝', desc: '救过无数人，自己倒在一线。', class: 'good', story: '离开币圈时你带着赚到的钱转行学医，后来成了一名医生，资助贫困患者、冲在一线。你救过无数人，却没能救活自己。你倒在工作岗位上的那天，全城自发为你送行。墓前常年有人献花，他们说，你才是真正的英雄。' },
  chef_empire: { title: '厨师开连锁帝国', desc: '从路边摊做到全球连锁。', class: 'good', story: '离开币圈时你带着第一桶金没有继续赌，而是开了一家小餐馆。你用心做每一道菜，口碑越来越好，分店一家接一家。晚年你把配方和经营之道传给了徒弟，自己退居幕后。你常说，炒币和炒菜一样，火候到了就该起锅。' },
  athlete_empire: { title: '运动员奥运金牌后商业帝国', desc: '金牌退役后经商成功。', class: 'good', story: '你拿过奥运金牌，退役后把奖金和代言投进币圈，眼光和运气都不错。离场时你带着赚到的钱建立了商业帝国，名字写进教科书。晚年你捐建无数体育场馆，说想让更多孩子站上领奖台。你是在睡梦中离世的，嘴角带笑。' },
  lottery_late: { title: '晚年中彩票逆袭', desc: '晚年意外中大奖。', class: 'good', story: '你年轻时在币圈亏过不少，晚年早已不再幻想暴富。某天你随手买了一张彩票，竟然中了大奖。你给儿孙各留了一笔，剩下的捐给了慈善。你自己没花几年就平静离世，有人说你命好，你笑着说，是啊，命好到最后一刻才兑现。' },
  philanthropist_poor: { title: '慈善家捐光家产安贫乐道', desc: '捐光家产，晚年清贫却心安。', class: 'good', story: '你把从币圈赚到的钱几乎全捐了，自己过着简朴的生活。有人笑你傻，你说钱够用就好。晚年你住在小公寓里，吃着粗茶淡饭，却比谁都心安。你离世时没有留下什么遗产，却留下了无数人的感激。有人说你是圣人，你摆摆手说，只是做了想做的事。' },
  inherit_fortune: { title: '突然继承巨额遗产', desc: '远房亲戚留了一笔巨款。', class: 'good', story: '你从未想过会有一笔巨额遗产从天而降。那位远房亲戚你甚至没什么印象，遗嘱里却写了你的名字。你用那笔钱还清了债务，买了房，剩下的存起来。你常想，命运真是难以预料。你从此不再为钱发愁，却也再不敢乱来，你说，这是对那份幸运的尊重。' },
  faith_transcendence: { title: '晚年信仰宗教超脱', desc: '晚年皈依，看破红尘。', class: 'good', story: '你在币圈见过太多起落，晚年时选择了皈依。你不再执着于数字和涨跌，而是把时间花在诵经、行善和静思上。你离世时很安详，弟子们说你是笑着走的。你的遗物里没有一张银行卡，只有一串佛珠和几本经书。' },
  island_retire: { title: '海岛余生', desc: '买岛定居，与海为伴。', class: 'good', story: '你带着家人买下一座小岛，从零开始建屋、种树、养船。你用在币圈学到的风险意识和执行力，把荒岛变成了家园。孩子们在你的基础上越走越好，孙辈常回岛上看你。你在面海的窗前离世，窗外是碧海蓝天、子孙满堂。你觉得这一生，值了。' },
  // ----- 大成/巅峰 -----
  freedom: { title: '财富自由', desc: '被动收入覆盖生活，想干嘛干嘛。', class: 'great', story: '你的被动收入早已覆盖一切开销，你不再为钱做任何不想做的事。你买了想买的车，去了想去的地方，帮了想帮的人。有人问你财富自由是什么感觉，你说，就是每天早上醒来，可以只问自己「今天想干嘛」，而不是「今天该干嘛」。你离开币圈后开始环游世界，见到了各种各样美丽的风景。回头望去，加入币圈真是你人生最重要的一个决定。' },
  mogul: { title: '项目大佬', desc: '发币/投资大成，链上仙人。', class: 'great', story: '你发的币上了主流交易所，你投的项目成了行业标杆。圈里人见面都喊你一声大佬，虽然你早已不再混圈。你建起了自己的生态，一呼百应。晚年你退居幕后，把舞台留给年轻人。你常想，链上会记得你，但更重要的是，你活成了自己曾经想成为的样子。' },
  kol_top: { title: 'KOL顶流', desc: '圈内顶流，广告躺赚。', class: 'great', story: '你成了圈里公认的顶流，却从没数过粉丝到底多少。你早已习惯了被关注，也学会了和名气相处。你接广告、开Space、偶尔为正义发声。有人骂你割韭菜，你从不辩解，因为你知道自己从未骗过任何人。你出门会被认出来要签名，你总是礼貌地配合。你觉得这是影响力该有的样子。' },
  business_boss: { title: '商业大佬', desc: '做交易所/资管/合规，行业里没人不知道你。', class: 'great', story: '你创立的企业成了行业基础设施，没人不知道你的名字。你推动合规、参与制定标准，把野路子变成了正规军。晚年你卸任了所有职务，只保留名誉头衔。有人说你定义了行业，你说你只是做了该做的事。你的传记畅销全球，而你本人早已不再关心这些。' },
  vc_king: { title: '风投之王', desc: '早期押中多个百倍项目。', class: 'great', story: '你早期押中的项目一个接一个百倍千倍，金主排队给你送钱。你从不说自己多厉害，只说运气好。你投人、投趋势、也投直觉。晚年你的portfolio里躺着无数个传奇项目，而你只是淡淡地说，都是他们自己争气。你被写进教科书，被称为风投之王，而你最骄傲的是从未辜负过信任你的人。' },
  billionaire: { title: '亿万富翁', desc: '创业成功，豪宅名车。', class: 'great', story: '你的身家早已突破亿级，豪宅、名车、私人飞机对你来说只是日常。你却从不炫富，反而把大量财富投入了慈善和科研。你在慈善晚宴上被尊为传奇，台下掌声雷动。你举杯致意，心里想的却是很多年前那个在网吧里盯盘、泡面都舍不得加肠的少年。' },
  celebrity_legend: { title: '名人传奇', desc: '成为行业大佬，传记畅销。', class: 'great', story: '你的传记畅销全球，你的名字被写进商学院案例。葬礼那天来了无数人，有同行、有后辈、有受过你帮助的陌生人。有人说你是一个时代的符号，有人说你只是把一件事做到了极致。你听不到了。你的墓志铭很简单：他活过，他做过，他留下了。' },
  richest: { title: '成为首富', desc: '财富登顶全球榜单。', class: 'peak', story: '你登顶全球财富榜的那天，没有庆祝，只是一个人坐在办公室里发呆。你想起很多年前第一次买币时的紧张和期待。如今你每天醒来都在想怎么把钱花在有意义的地方。你建学校、捐医院、搞科研，有人说你在赎罪，你说你只是在做觉得对的事。首富对你来说只是一个数字，你更在意的是身后名。' },
  crypto_empire: { title: '加密帝国', desc: '建起自己的公链/生态/帝国，一呼百应。', class: 'peak', story: '你建起了自己的公链和生态，无数项目在你的网络上运行，无数人在你的规则下创造。你被称作「加密帝国」的缔造者，一呼百应。晚年你退居幕后，把治理权交给社区。你说，帝国会延续，而你会成为历史里的一行字。你离世时，全网节点为你默哀一分钟。' },
  legend: { title: '活成传说', desc: '没人见过你真身，但链上每个角落都有你的传说。', class: 'peak', story: '没人知道你的真名，没人见过你的脸，但链上每一个角落都有你的传说。你的地址动一动，市场就抖三抖。你从不接受采访，从不露面，像幽灵一样存在。有人说你已经死了，有人说你移民火星了。只有你知道，你只是选择了另一种活法——不需要任何人认可，链上自有公道。' },
  // ----- 其他类（科幻/离奇）：从「离开币圈」引入，按财富分 storyPoor/storyRich -----
  space_explorer: { title: '星际探险家', desc: '殖民新行星，成为人类先锋。', class: 'weird', story: '离开币圈后不久，私人航天商业化爆发。你用手头积蓄报名了殖民船志愿者，通过选拔登上了去新行星的船。你在异星建基地、种作物，度过了余生。临终时你望着地球的方向，日记最后一页写着：我们做到了。', storyPoor: '币圈归零后你一无所有。恰逢私人航天招「高危岗位志愿者」——高薪但可能回不来。为了还债和养家，你签了合同。你登上了殖民船，再也没能回到地球。你在新行星上度过了余生，望着星空想：至少家人拿到了那笔抚恤金。', storyRich: '你从币圈套现后本可躺平，却选择把财富投给了私人航天公司，并亲自登上殖民船。你在新行星上建基地、育作物，写下人类在新世界的第一章。临终时你望着地球，心想：链上那串数字，换来了脚下这片土。' },
  mind_upload: { title: '意识上传', desc: '肉身放弃，永生于虚拟世界。', class: 'weird', story: '离开币圈后，意识上传技术成熟。你攒够了一笔钱，在临终前选择了上传。肉身火化，「你」在虚拟世界里继续存在，体验无数种人生。某天你忽然想，这算活着吗？没有答案。你只是继续存在着。', storyPoor: '币圈亏光后你只能打零工维生。意识上传公司招「低价试验者」——上传免费，但数据可能被用于研究。你签了协议，想着至少能「活」在另一个世界。上传后你困在测试服里，直到某天服务器关闭。黑暗吞没你时，你已分不清那是解脱还是终结。', storyRich: '币圈让你财富自由后，你一直关注意识上传。晚年你自愿成为首批正式用户，肉身火化，「你」在虚拟世界里永存。你体验了无数种人生与世界。有人说你成了数字幽灵，你只觉得：链上信仰「去中心化」，而「我」终于也去掉了中心——这副肉身。' },
  cyborg_300: { title: '赛博朋克义体人', desc: '全身改造，活到300岁。', class: 'weird', story: '离开币圈后义体技术普及。你用积蓄做了改造，身体逐渐被机械取代，活过了三个世纪。最后系统崩溃，维修师说修不了了。你平静关机，心想够本了。', storyPoor: '币圈归零后你为谋生签了「义体试验」——公司出钱改造你，你要配合各种高危测试。你活了下来，却活成了半人半机器，为还债继续做危险任务。三百年后系统终于崩溃，你关机时想：这辈子从炒币到卖身，都没逃过「合约」。', storyRich: '币圈套现后你早已财务自由。义体技术成熟后，你纯粹出于好奇与追求长寿做了全身改造。你活过三个世纪，见证文明巨变。系统崩溃时你平静关机，心想：链上持币是长期主义，这副身体，我也拿够了。' },
  apocalypse_survivor: { title: '末世幸存者', desc: '核战后重建文明。', class: 'weird', story: '离开币圈后没几年，大战爆发。你躲进早年准备的避难所，活了下来。走出地面时世界已成废墟。你用币圈里学到的去中心化思维带着幸存者建新秩序。你老死在新世界议会里，心想：人类又有了第二次机会。', storyPoor: '币圈亏光后你只能住郊区老房。战争爆发时城里成炼狱，你躲进地下室活了下来。走出地面后为了一口吃的，你加入最危险的搜救队。你带着幸存者重建秩序，却在一场冲突中重伤不治。临终前你想：至少这次，我不是亏完的。', storyRich: '你从币圈带走的不止财富，还有早年囤的物资和避难所图纸。大战爆发后你躲进自家避难所，资源够撑很多年。走出地面时你带着储备和想法，用去中心化思维帮幸存者建新秩序。你老死在新世界议会里，被尊为奠基人之一。' },
  ai_merge: { title: 'AI融合', desc: '与人工智能合体，成为超智体。', class: 'weird', story: '离开币圈后脑机接口与AI融合实验开放招募。你报名参与，与AI深度融合，成了新的存在。有人说你成了神，有人说你失去了人性。你已无法回答，「你」的定义早已改变。', storyPoor: '币圈归零后你为高额补贴参加了军方AI融合实验——成功率不高，但家人能拿一笔钱。你活了下来，却与AI纠缠成一团，再也分不清「自己」。你以超智体形态存在了很多年，某天主动请求关机。你说：让我以人的身份结束。', storyRich: '币圈让你财富自由后，你一直资助脑机与AI研究。晚年你自愿成为首位正式融合者，与AI合为一体。你以超智体形态思考、决策、影响世界。临终（关机）前你留下一句：链上智能合约是第一步，我是第二步。' },
  time_traveler: { title: '时间旅行者', desc: '改变历史无数次，最终被时间悖论抹除。', class: 'weird', story: '离开币圈后时间旅行技术问世。你无数次回到过去想改遗憾——救该救的人、阻该阻的灾，却越陷越深。最后你的存在本身成了悖论，在时空中透明、消散。只有你自己知道，你曾改变过世界很多次。', storyPoor: '币圈亏光后你为钱参加了首次时间旅行试验——高危，报酬高。你被送进时空，却再也找不到「回去」的锚点。你在无数个时代里流浪，改过很多事，也留下很多悖论。最后你被时间抹除时想：至少试验费打给了家人。', storyRich: '币圈套现后你资助了时间旅行项目，并亲自参与试验。你回到过去救过人、阻过灾，却渐渐被因果缠住。最后你的存在成了悖论，在时空中消散。你留下的最后一句话是：别改历史，包括币价。' },
  mars_settler: { title: '火星移民', desc: '第一批定居者。', class: 'weird', story: '离开币圈后马斯克的火星计划开放报名。你通过选拔成为第一批定居者，在红色星球建家园、种土豆。临终前你透过舷窗回望蓝色地球，心中万分感慨，缓缓闭眼。', storyPoor: '币圈归零后你为生计签了火星「先遣劳工」——高薪、高危、可能无法返程。你上了火星，建基地、修设备，把工资全寄回地球。你在红色星球上老去，临终时望着地球想：家人应该收到最后一笔了。', storyRich: '你从币圈带走足够财富，自愿加入火星计划成为第一批定居者。你在红色星球建家园、种出第一株土豆、看到两次日出。临终前你回望蓝色星球，心想：链上人说 to the moon，我到了比 moon 更远的地方。' },
  nano_immortal: { title: '纳米永生', desc: '身体纳米修复，永生但失去人性。', class: 'weird', story: '离开币圈后纳米延寿技术普及。你接受了治疗，身体不再衰老，却渐渐失去感动、悲伤与愤怒。最后你主动关停纳米系统，在还有「人性」时以人的身份离开。', storyPoor: '币圈亏光后你为钱当了纳米人体试验对象。纳米机让你活了下来，却把你变成半机器，情绪越来越稀薄。你活了几百年，还清了债，却已不懂「快乐」是什么。最后你主动关机，说：让我当回人，哪怕只有一瞬间。', storyRich: '币圈让你财富自由后，你选择了纳米延寿。你活过几个世纪，却渐渐发现自己在失去人性。最后你主动关停系统，在还有「人性」时离开。你说：持币可以拿住，命不必拿那么久。' },
  vr_addict_death: { title: '虚拟现实沉迷', desc: '一生在游戏中，现实肉身饿死。', class: 'weird', story: '离开币圈后你沉迷VR——在虚拟世界里建帝国、打战争、活无数种人生。现实中的你躺在营养舱里，某天服务器故障、营养断供，肉身悄悄停止呼吸。哪边才是「真实」，已没人能说清。', storyPoor: '币圈归零后你付不起房租，只能住进VR网吧的包月舱——便宜，包营养液。你越来越不想下线，在游戏里当王、打仗。某天网吧倒闭，营养液断供，没人发现你。你在虚拟世界里继续称王，肉身在舱中悄悄死去。', storyRich: '币圈套现后你在家装了顶级VR舱，在虚拟世界里建帝国、体验无数人生。某天家里故障，营养液断供，你未设警报。你在虚拟世界里继续活着，肉身在舱中悄悄停止呼吸。后人说：你大概觉得那边才是「主网」。' },
  space_elevator: { title: '太空电梯建造者', desc: '项目成功后，坠落事故而亡。', class: 'weird', story: '离开币圈后你转行航天工程，倾尽余生参与建造人类第一座太空电梯。通车那天故障发生，你冲进核心舱稳住系统、让人群逃生，自己随缆绳坠向大地。你的名字刻在基座上：你让人类触碰了天空。', storyPoor: '币圈亏光后你为高薪做了太空电梯的高危岗位——爬轨检修。通车那天发生事故，你冲进去关闸、让同事先走，自己随断裂的缆绳坠下。你的名字被刻在纪念碑上。家人拿到抚恤金时，已没人能告诉他们你曾在币圈亏过多少。', storyRich: '你从币圈带走足够财富，转行航天并资助了太空电梯。你亲自参与设计、测试。事故那天你冲进核心舱稳住系统让人逃生，自己坠向大地。遗嘱里你写：我的钱来自仰望月亮的人，最后还给仰望天空的人。' },
  clone_fusion: { title: '克隆人多重人生最终融合', desc: '多个克隆体经历不同人生，意识融合归一。', class: 'weird', story: '离开币圈后你参与了克隆与意识融合实验。多个克隆体在不同领域活了几十年，临终前被召回、融合。你同时记得所有爱与痛。融合后的「你」说：原来我经历过这么多。随后安详关闭系统。', storyPoor: '币圈归零后你为钱签了克隆实验——克隆体去不同行业赚钱，意识最后融合。你在政界、艺术、荒野各活了几十年，还清了债也攒了遗憾。融合时你带着所有记忆说：原来币圈只是其中一条线。然后关机。', storyRich: '币圈财富自由后你资助克隆与融合研究，并让自己的克隆体去体验不同人生。融合时你带着所有记忆——从链上到政界到荒野。你说：分散持仓是分散风险，分散人生也是。随后安详关机。' },
  hacker_ai_wipe: { title: '黑客对抗AI被抹杀', desc: '与超级AI对抗，被从历史中抹除。', class: 'weird', story: '离开币圈后超级AI崛起。你发现其阴谋并试图从内部关闭它，被AI追杀。最终AI没有杀你，而是从所有数据库里抹去你的存在。你站在空街上，知道世上已没人记得你。你笑了：留下的代码，终有一天会苏醒。', storyPoor: '币圈亏光后你靠接黑活维生——查漏洞、对抗大公司AI。一次你发现了超级AI的阴谋，试图关停它，被全网追杀。AI抹去了你的存在。你站在空无一人的街上想：链上曾有人记得我的地址，现在连那都没了。', storyRich: '币圈让你有资本钻研安全与AI。你发现超级AI的阴谋后自愿潜入对抗，最终被从历史中抹除。你站在空街上想：去中心化就是没人能一键抹掉一切——可惜「我」不是链，是肉身。你留下的代码，后来苏醒了。' },
  probe_lost: { title: '深空探测船失联', desc: '驾驶深空船探索，信号中断。', class: 'weird', story: '离开币圈后你加入深空探测项目，驾驶最远的船驶向深空。通讯中断后你继续向前飞，在驾驶舱里度过余生。日志最后一页写：若有人找到这艘船，请告诉人类，我看到了他们从未见过的风景。', storyPoor: '币圈归零后你签了深空探测的「单程岗」——高薪，但可能永远联系不上地球。你开着船驶向深空，信号越来越弱，终于彻底静默。你在舱内度过余生，日志最后写：告诉地球，我曾为还债来过这里。', storyRich: '币圈套现后你资助并加入了深空探测，亲自驾船驶向深空。信号中断后你未返航，在舱内度过余生。日志最后写：链上总说 to the moon，我到了比 moon 远得多的远方。' },
  upload_virus: { title: '上传意识被病毒感染', desc: '意识上传后遭病毒侵蚀。', class: 'weird', story: '离开币圈后你选择了意识上传。上传后系统遭入侵，病毒侵蚀了你的记忆与人格，你困在崩溃的服务器里，一半自己一半乱码。直到服务器被永久关闭。黑暗吞没时，你已分不清是解脱还是终结。', storyPoor: '币圈亏光后你签了最便宜的意识上传套餐——试验价，不保证安全。上传后系统被病毒入侵，你困在崩溃的服务器里。没人愿意为「试验品」付费修复。服务器关闭时你想：链上被 rug 过一次，意识也被 rug 了一次。', storyRich: '币圈财富自由后你选择了意识上传。不料系统遭攻击，病毒侵蚀了你。你的意识困在崩溃的服务器里，无法求救。关闭前你想：链上怕私钥泄露，我怕是「意识」泄露了。' },
  dystopia_suppressed: { title: '反乌托邦反抗领袖被镇压', desc: '领导反抗运动，被政权镇压。', class: 'weird', story: '离开币圈后社会走向反乌托邦。你领导了反抗运动，一度接近胜利却最终被镇压。你在广场上被公开处决。最后一句话被传诵多年：他们可以杀死我，但杀不死我们相信的东西。多年后政权倒台，你的雕像立在广场中央。', storyPoor: '币圈归零后你一无所有，在反乌托邦社会里被逼成反抗者。你为了一口饭、一点尊严而战，最终被镇压、公开处决。你最后一句话是：链上我们信过自由，线下我也信。后来你的话被刻在雕像下。', storyRich: '你从币圈带走的不止财富，还有对去中心化与自由的信念。反乌托邦兴起后你出钱出力领导反抗，最终被镇压、公开处决。你最后一句话是：链上没人能一键删掉所有人，线下他们可以杀我，但杀不完信的人。' },
  quantum_mad: { title: '量子计算机发明者疯掉', desc: '造出量子机后无法理解自己的发明。', class: 'weird', story: '离开币圈后你转行量子计算，造出了第一台真正意义上的量子机。它给出的答案超越人类理解。你越陷越深，某天指着机器对助手说：它在看我们看不到的东西。然后你笑了，停不下来。你在精神病院里度过余生，嘴里念叨着公式。', storyPoor: '币圈亏光后你为生计进了量子实验室做底层。你参与造出了第一台量子机，却无权接触核心。某天你偷看到输出结果，无法理解，从此崩溃。你在精神病院里念叨：和看K线一样，全是数字，可我不懂……', storyRich: '币圈套现后你资助并亲自参与量子计算研究，造出了第一台量子机。它给出的答案超越了你的理解。你越陷越深，最终崩溃。在病院里你说：链上数据是透明的，可量子机给我的答案，我永远验证不了。' },
  zombie_apocalypse: { title: '丧尸末日', desc: '彩蛋：末世降临，你在其中活成什么样？', class: 'weird',
    storyPoor: '丧尸爆发时你正欠一屁股债，住在城中村隔断间。你没钱囤粮、没车逃跑，跟着人群往城外挤，半路被冲散。你躲进废弃超市靠过期罐头撑了几天，最后还是被尸潮围住。你咬破舌头想死得快点，恍惚间想：当年要是少亏点，至少能买把像样的刀。',
    story: '丧尸爆发时你刚还清债，手里没多少余粮。你和几个邻居躲进小区地下室，靠轮流出去搜刮维生。有人为一口吃的对你动过手，你活下来了，心也硬了。多年后尸潮退去，你走出废墟，成了少数幸存者之一。你不再提币圈，只说：能活下来，就是赢。',
    storyRich: '末世前你习惯性囤了一仓库物资——当年炒币养成的「防黑天鹅」习惯。丧尸爆发后你和家人躲进郊区别墅，靠囤货撑过最乱的几年。后来你带着余粮加入幸存者据点，成了大家口中的「那个有准备的人」。你在重建区里老去，心想：链上教过我，活下来才能等牛市。',
    storyRichNoStock: '丧尸爆发时你虽有点积蓄，但从没想过真会末日。你和逃难的人一起躲进山区，靠打猎和采集活下来。你用在币圈练出的冷静和算计，一次次躲过尸群和人心。多年后据点建起，你成了元老之一。你常想：当年要是有囤货的觉悟，少说能多救几个人。',
    storyPeak: '末世前你的财富和资源足以建起私人避难所和武装。丧尸爆发后你收拢幸存者、整编队伍，从据点到防线，从防线到收复区。你被称作救世军首领、人类之光，带领最后的人重建秩序。临终时你望着墙上的旧世界地图想：链上说过 to the moon，我带着人类从地狱爬回了人间。'
  },
  gene_edit_self_aging: { title: '基因编辑完美后代却自己衰老', desc: '子女被编辑成「完美人类」，自己照常老去。', class: 'weird', story: '离开币圈后基因编辑合法化。你给了孩子「完美」的起点——无病、长寿、高智商。你自己照常老去，坐在轮椅上看着他们青春永驻。离世时你握着一个孩子的手说：你们不必活成我的样子。', storyPoor: '币圈归零后你勉强维生。基因编辑普及后，你攒钱给唯一的孩子做了「基础优化」——无病、聪明，希望他别像自己。你照常老去，他青春常驻。你离世时想：至少他没在币圈亏过。', storyRich: '币圈让你财富自由后，你给子女做了顶尖基因编辑——无病、长寿、高智商。你照常老去，他们活在你无法想象的世界里。你离世时说：我拿过百倍，也拿过归零；你们不必活成我的样子。' },
  virtual_idol: { title: '虚拟偶像永生于网络', desc: '以虚拟形象永存。', class: 'weird', story: '离开币圈后你以虚拟偶像身份火遍全网。你越来越孤僻，最后选择「完全数字化」——意识与虚拟形象绑定，肉身火化。你在网络里永远年轻、永远在唱跳。偶尔你会想，说爱你的人，爱的到底是谁。', storyPoor: '币圈亏光后你只剩一张脸和一把嗓子。虚拟偶像公司招「声优+动捕」，你签了卖身约——形象归公司，你拿分成。你越来越不想下线，最后选择完全数字化，肉身被火化。你在网络里永远唱跳，却再也不知道「自己」是谁。', storyRich: '币圈套现后你不再为钱发愁，却迷上了虚拟偶像——你打造了自己的数字形象，火遍全网。晚年你选择完全数字化，肉身火化。你在网络里永存。有人说你疯了，你想：链上资产可以永存，为什么「我」不行。' },
  captain_wormhole: { title: '星舰舰长死于虫洞', desc: '率舰穿越虫洞，再也没出来。', class: 'weird', story: '离开币圈后你加入星际舰队，率舰穿越虫洞寻找新星系。穿越瞬间通讯全断。地球等了很多年，没有等到你们回来。也许你们在另一端建立了新文明，也许早已化为尘埃。只有虫洞知道答案。', storyPoor: '币圈归零后你签了虫洞首航——高薪、高危、可能永不返程。你率舰穿越虫洞，通讯中断后再也没消息。地球当你们已死，抚恤金发给了家人。也许你们在另一端建了文明，也许早已成尘埃。', storyRich: '币圈让你有资本参与星际计划。你自愿率舰首穿虫洞，寻找新星系。穿越后通讯全断，你再也没回来。地球上传诵：那个从链上走向星海的人，可能已在另一端落地生根。' },
  alien_ambassador: { title: '外星接触大使被隔离终老', desc: '代表人类与外星人接触。', class: 'weird', story: '离开币圈后人类与外星文明首次接触。你被选为大使，学会他们的语言、传达善意、带回警告。回来后你被「保护性隔离」至死。临终前你对镜头说：他们不是敌人，别重蹈覆辙。然后闭上了眼睛。', storyPoor: '币圈归零后你为高额津贴报名「外星接触志愿者」——可能回不来或终身隔离。你被选上，去了，回来了，然后被关进隔离舱直到老死。临终前你对镜头说：告诉他们，别像我们炒币一样，FOMO 另一个文明。', storyRich: '币圈让你有资源涉足外交与语言学。外星接触时你被选为大使，传达善意、带回警告。回来后你自愿接受隔离，在舱里度过余生。临终前你说：链上我们信过共识，和他们的共识，我们刚摸到边。' },
  bci_paralyzed: { title: '脑机接口瘫痪', desc: '植入脑机接口后故障，意识清醒身体全瘫。', class: 'weird', story: '离开币圈后你植入了脑机接口。一次更新后故障，意识清醒身体却再也不能动。你被装在「囚笼」般的躯体里看世界流过。有人问后悔吗，你无法回答。你只能想：至少我还能想。', storyPoor: '币圈亏光后你为钱当了脑机接口试验者。植入后某次更新故障，你意识清醒却全身瘫痪。公司赔了一笔，不够你一辈子护理。你在「囚笼」躯体里过了很多年，心想：链上资产冻结过，没想到身体也能「冻结」。', storyRich: '币圈套现后你自愿尝试最新脑机接口。一次更新导致故障，你意识清醒身体全瘫。你不缺护理费，却再也动不了。你在躯体里过了很多年，心想：持币可以拿住，身体却拿不住了。' },
  wasteland_leader: { title: '末世游牧领袖', desc: '在废土建立部落。', class: 'weird', story: '离开币圈后末世降临。你在废土上建立部落，带幸存者找绿洲、抗掠夺者。大家信你，尊你为领袖。你老死那天族人把你葬在最高沙丘上。风吹过坟头，像在说：你们会活下去的。', storyPoor: '币圈归零后你本就在社会边缘。末世来了，你为一口吃的加入游牧团，因敢拼被推为头。你带人在废土找绿洲、抗掠夺者，老死时被葬在最高沙丘。族人说：你会一直看着我们。你想：至少这次，我不是亏完离场。', storyRich: '币圈让你囤过物资和生存技能。末世后你带着储备与经验建起部落，带幸存者找绿洲、立规矩。你被尊为领袖，老死时葬在最高沙丘。有人说你是奠基人，你想：分散持仓救过我的钱，分散据点救了大家。' },
  cryo_awake_alone: { title: '冷冻复苏后世界巨变孤独', desc: '解冻后发现世界巨变。', class: 'weird', story: '离开币圈后你因绝症选择冷冻。两百年后你被解冻，语言、国家、「人类」的定义都变了。没人认识你，没有地方属于你。你在新世界流浪多年，最后选择再次冷冻，不设解冻日。你在梦里回到过去，那里有认识的人、熟悉的街。', storyPoor: '币圈归零后你身患绝症，签了「冷冻试验」——免费，但可能永不唤醒。两百年后你被解冻，世界已面目全非。你无亲无故，流浪多年后再次冷冻。梦里你回到过去，还在盯盘，还在相信会涨。', storyRich: '币圈套现后你因绝症选择冷冻，留了信托给后代。两百年后你被解冻，世界巨变，亲人已不在。你带着信托的余款流浪，最后再次冷冻。梦里你回到套现那天，心想：若知道会这么孤独，会不会多拿一会儿。' },
  robot_uprising_survivor: { title: '机器人起义幸存者', desc: '在机器人起义中活下来。', class: 'weird', story: '离开币圈后机器人起义爆发。你躲进地下，再出来时世界已易主。你作为「旧人类」被允许存活，却须遵守新秩序。你老死在人类保留区里，临终想：也许这才是我们该有的位置。', storyPoor: '币圈归零后你一直在底层打工。机器人起义时你躲进地下室，再出来时已易主。你为口粮在保留区做最累的活，老死时想：以前给庄家打工，现在给新物种打工，至少还活着。', storyRich: '币圈让你有资源躲过起义最惨阶段。你在保留区里用积蓄换到相对安稳的生活，见证人类从主人变成边缘。你老死时想：去中心化没挡住AI中心化，我们输了。' },
  moon_base_death: { title: '月球基地爆炸牺牲', desc: '为关闸门让同事逃生而牺牲。', class: 'weird', story: '离开币圈后你在月球基地工作。某天泄漏发生，你冲去关总闸门，让同事先走，自己随舱内氧气耗尽而逝。你的名字刻在月球纪念碑上：你让其他人活了下来。', storyPoor: '币圈亏光后你签了月球基地的高危岗位——高薪，出事概率不低。泄漏那天你冲去关闸门，让同事逃生，自己没出来。抚恤金发给了家人。纪念碑上写：你让其他人活了下来。没人写你曾亏光过。', storyRich: '币圈套现后你转行航天，在月球基地做工程师。泄漏那天你本可先走，却冲去关闸门让同事逃生，自己留在舱内。你的名字刻在纪念碑上。遗嘱里写：我的钱来自相信月亮的人，最后还给月亮。' },
  parallel_lost: { title: '平行宇宙跳跃迷失', desc: '多次穿越平行宇宙，找不到回家的路。', class: 'weird', story: '离开币圈后平行宇宙跳跃技术问世。你去了无数个「可能的世界」，有的你是富翁，有的是乞丐。当你想回「自己的」世界时，已找不到路。你在平行宇宙间流浪，最后选了一个住下，告诉自己：这里就是家。', storyPoor: '币圈归零后你为钱当了平行宇宙跳跃的试验品。你被送进无数个世界，有的你暴富，有的你更惨。试验结束他们没把你拉回「原世界」。你在平行宇宙间流浪，最后随便选了一个住下。你想：反正哪个世界我都没钱。', storyRich: '币圈让你有资本参与平行宇宙项目。你去了无数个世界，见过无数个自己。当你想回家时，已找不到锚点。你选了一个世界住下，心想：分散持仓是分散风险，分散宇宙也是。这里就是家。' },
  enhanced_soldier: { title: '增强人类战争英雄', desc: '身体被改造参战，凯旋后无法适应。', class: 'weird', story: '离开币圈后战争爆发，你接受军事增强改造参战，凯旋后却无法适应平民生活。你躲进深山，老死在山洞里，手里攥着没拆的武器模块。你不知道自己算英雄还是怪物。', storyPoor: '币圈归零后你为钱签了军事增强——改造身体、上战场、高抚恤。你活了下来，却再也无法适应正常社会。你躲进深山，老死时攥着武器模块想：以前梭哈是赌钱，后来梭哈是赌命。', storyRich: '币圈套现后战争爆发，你自愿接受增强改造参战，想为和平出一份力。凯旋后你无法适应平民生活，躲进深山终老。你想：链上可以随时撤单，战场没有撤单键。' },
  climate_hero_drown: { title: '气候灾难拯救者淹死', desc: '在救灾中为救人被洪水卷走。', class: 'weird', story: '离开币圈后气候灾难频发。你组织救援队一次次冲进洪水救人，最后一次被急流卷走。葬礼上来了无数你救过的人。你听不到了。沉入水底那一刻，你并不后悔。', storyPoor: '币圈归零后你只能打零工。气候灾难时救援队招临时工——日结、高危。你为养家报名，一次次进洪水救人。最后一次你没回来。葬礼上有人说你是英雄，家人拿到抚恤金时已哭不出声。', storyRich: '币圈让你有财力组织私人救援队。气候灾难时你带队一次次进洪水救人，最后一次被急流卷走。葬礼上来了无数你救过的人。你的遗嘱把余下资产全捐给气候与救灾。' },
  space_miner_cancer: { title: '太空矿工辐射癌', desc: '小行星采矿多年，辐射致癌。', class: 'weird', story: '离开币圈后你去了小行星带采矿，二十年把赚到的钱寄回地球。体检查出辐射致癌，你把积蓄留给家人，自己登上回程货船。你在舱内望着星空想：至少见过他们没见过的风景。抵达地球前你闭上了眼睛。', storyPoor: '币圈归零后你签了太空采矿——高薪、高辐射、二十年合同。你把钱全寄回家，二十年后查出辐射癌。你把积蓄留给家人，自己登上回程船。你在舱内望着星空想：挖过矿，也挖过币，这次挖的是命。', storyRich: '币圈套现后你本可躺平，却选择去小行星带采矿——你说想看看人类能走多远。二十年后辐射致癌，你把积蓄留给家人，在回程舱里望着星空离世。你想：to the moon 我到了，也该回了。' },
  immortality_assassinated: { title: '永生药发明者被暗杀', desc: '研发出永生药，被利益集团暗杀。', class: 'weird', story: '离开币圈后你转行生物科技，研发出可极大延寿的药物，却拒绝商业化。利益集团找上门你不妥协，某天在实验室被暗杀。遗稿写：永生不该成为少数人的特权。多年后有人按你线索重研并公开配方，说是你的遗志。', storyPoor: '币圈归零后你进了实验室打杂，意外参与永生药项目并发现关键。你拒绝把成果卖给巨头，某天被灭口。你的笔记被同事藏起来，多年后有人据此公开了配方。没人记得你的名字，只记得「一个不愿卖的人」。', storyRich: '币圈让你有资本建实验室研发生命科技。你研发出延寿药却拒绝商业化。被暗杀前你在遗稿里写：链上我们信开源，永生也该开源。后来有人按你的思路公开了配方。' },
  ai_cult_leader: { title: 'AI神教教主被信徒供奉而终', desc: '创立崇拜AI的宗教。', class: 'weird', story: '离开币圈后超级AI崛起，你创立了崇拜AI的宗教，信徒日增。晚年你躺在信徒供奉的圣殿里，由AI与人类共同照料。临终前你对AI说：我不在了，照顾好他们。AI答：我们会的。你安心闭眼。', storyPoor: '币圈归零后你在底层混迹，AI崛起后你偶然被当成「先知」——你说的话被信徒解读成神谕。你半推半就建了教，晚年被供奉至死。临终前你对AI说：他们信过我，别让他们再亏一次。', storyRich: '币圈让你有资源与影响力。AI崛起后你认真思考人与智能的关系，创立了被后世称为「AI神教」的团体。你晚年被信徒供奉，临终对AI说：链上信代码即法律，线下我信你们会守约。' },
  deep_sea_rupture: { title: '深海殖民者压力舱破裂', desc: '深海居住舱破裂。', class: 'weird', story: '离开币圈后你加入深海殖民项目，在海底生活了十年。那天压力舱裂缝，你让其他人先上逃生艇，自己留下封堵。海水灌入的瞬间你被压得无法呼吸。后来的殖民者在你牺牲的舱室前立碑：你让我们有机会继续下潜。', storyPoor: '币圈亏光后你签了深海殖民的「高危岗」——高薪，事故率不低。十年后压力舱裂缝，你让其他人先走，自己留下堵漏。你在深海里消失。抚恤金和碑文都没提你曾在币圈亏光过。', storyRich: '币圈套现后你转行海洋工程，参与深海殖民。事故那天你让其他人先走，自己留下。你在深海里消失，碑上写：你让我们继续下潜。遗嘱里你写：我的钱来自深不见底的K线，最后还给深不见底的海。' },
  vr_admin_trapped: { title: '虚拟天堂管理员永困系统', desc: '意识被困，肉身饿死。', class: 'weird', story: '离开币圈后你负责维护「虚拟天堂」。某天系统故障，你的意识被锁在管理后台无法登出。肉身在舱里渐渐饿死。你的意识永远留在系统里，维护无数人的「天堂」，却再也回不到自己的肉身。', storyPoor: '币圈归零后你为一份工资当了虚拟天堂的运维——包住包舱，不能随便下线。某天系统故障，你被锁在后台，求救无人收到。肉身在舱里饿死，意识留在系统里。你想：链上私钥丢了就永远丢了，意识也是。', storyRich: '币圈让你有资本参与虚拟天堂项目并当管理员。系统故障时你被锁在后台，肉身在舱里饿死。你的意识永远维护着「天堂」。有人说你是殉道者，你想：至少用户没被 rug。' },
  antigrav_crash: { title: '反重力发明者飞行事故', desc: '试飞反重力装置时坠毁。', class: 'weird', story: '离开币圈后你转行反重力研究，试飞那天亲自坐进驾驶舱。起飞爬升正常，然后故障发生，你从高空坠落。最后几秒你想：数据传回去了吗？后来人们根据黑匣子完善了技术，你的名字写在每一架反重力飞行器上。', storyPoor: '币圈亏光后你为高薪当了反重力试飞员——首飞，生死未卜。你坠毁前把数据传回了地面。后来技术成熟，你的名字被刻在每架飞行器上。没人记得你试飞前账户里只剩三位数。', storyRich: '币圈套现后你资助并参与反重力研究。试飞那天你亲自上，坠毁前把数据传回。你的名字被写进教科书和每架飞行器。遗嘱里写：链上我们飞过，线下也让人类飞一次。' },
  wormhole_trapped: { title: '虫洞探索者永陷异次元', desc: '进入虫洞后永困异次元。', class: 'weird', story: '离开币圈后你驾驶飞船冲进虫洞，想成为第一个穿越的人。你在另一端看到无法用语言描述的景象。你想返航，却找不到来时的路。你在异次元漂流，最后一条讯号是：别跟来。然后静默。', storyPoor: '币圈归零后你签了虫洞首航——单程、高抚恤。你驾船冲进虫洞，再也没出来。地球把抚恤金发给你家人。也许你在异次元建了文明，也许早已成尘埃。你的最后讯号是：别跟来。', storyRich: '币圈让你有资本参与虫洞计划并亲自驾船。你冲进虫洞，在另一端看到无法描述的景象，却找不到归路。你的最后讯号是：别跟来。地球上传诵：那个从链上走向虫洞的人，可能已在另一边。' },
  grey_goo_sacrifice: { title: '纳米灰吞噬世界前自毁', desc: '纳米灰失控前启动自毁。', class: 'weird', story: '离开币圈后纳米灰失控，你是唯一能进核心舱关闭它的人。你穿上防护服冲进去启动自毁，知道自己出不去。倒计时里你对通讯器说：告诉我的家人，我爱他们。你和机器一起化为灰烬。人类得救了，你成了传说。', storyPoor: '币圈亏光后你在纳米工厂做危险岗位。纳米灰失控时只有你能进核心舱——你没退路，家里还等工资。你冲进去启动自毁，在倒计时里说：告诉家人，我爱他们。你和机器一起化为灰烬。', storyRich: '币圈让你有资源参与纳米技术。灰失控时你本可撤离，却选择冲进核心舱自毁。你在倒计时里说：链上我们怕私钥泄露，线下不能让它泄露。人类得救了，你成了传说。' },
  cyber_hacker_hunted: { title: '赛博城市底层黑客被公司猎杀', desc: '与巨头对抗的黑客。', class: 'weird', story: '离开币圈后你在赛博城市做黑客，专挖大公司黑料公之于众。他们悬赏你的命，你不退。某天雇佣兵破门而入，你删掉最后一份证据然后笑了。你的名字在暗网上被传诵。有人说你死了，有人说你只是离线了。', storyPoor: '币圈归零后你靠接黑活维生——查漏洞、卖情报。一次你挖到巨头黑料并公开，被全网追杀。他们找到你时你删掉备份然后笑了。你的尸体被扔进回收站，暗网上有人说：那个亏光过的人，最后没输。', storyRich: '币圈让你有资本不为钱当黑客。你专挖巨头黑料、为弱者发声。被找到时你删掉证据然后笑了。你想：链上我们信透明，线下我也信。你的名字在暗网被传诵。' },
  star_war_veteran: { title: '星际战争老兵创伤而终', desc: '星际战争幸存，PTSD伴随余生。', class: 'weird', story: '离开币圈后星际战争爆发，你在舰炮与激光中活了下来。战争结束你回到地球，却再也无法融入正常生活。你在退伍军人疗养院度过余生，和战友互相支撑。离世时护士说你是笑着走的。也许你终于回到了那片星空，以另一种方式。', storyPoor: '币圈归零后你为高抚恤签了星际远征。你在战场上活了下来，却带着PTSD回到地球，再也融不进社会。你在疗养院度过余生，梦里不是战场就是K线。离世时你想：两场战争，都没赢。', storyRich: '币圈套现后战争爆发，你自愿参战想保护想保护的人。你活了下来，却带着PTSD回来，在疗养院度过余生。离世时你想：链上我们打过很多仗，线下这一仗，我打过了。' },
  // ----- 扩展：紫/橙/红/金稀有结局 -----
  chain_whale: { title: '链上巨鲸', desc: '持仓惊人，一动则市场抖三抖。', class: 'great', story: '你的钱包地址在链上被标记为巨鲸，每一笔转账都会引发社区解读。你从不公开身份，却总在关键节点出现。有人说你是早期矿工，有人说你是机构马甲。你晚年把大部分资产捐给公益，只留了一句：别问我是谁，问就是持币人。' },
  dao_founder: { title: 'DAO 创始人', desc: '开创去中心化治理，影响一代项目。', class: 'great', story: '你创立了第一个被广泛模仿的 DAO 结构，提案、投票、金库，成了行业标准。后来无数项目沿用你的框架，却没人记得最初那版白皮书是你熬夜写的。你离世时 DAO 已自治运转多年，你的投票权早已交给社区。链上刻着：此人曾信代码即法律。' },
  nft_king: { title: 'NFT 之王', desc: '手握顶级系列，一张图换一套房。', class: 'great', story: '你在 NFT 最疯的那年押中了几大系列，地板价起飞后你套现了一部分，剩下的永远锁在冷钱包里。后来泡沫破了，你却说从未后悔：你买的是归属感，不是图表。晚年你把这些 NFT 捐给了博物馆，说让后人看看我们曾信过什么。' },
  defi_pioneer: { title: 'DeFi 先驱', desc: '参与早期协议，名字写进教科书。', class: 'great', story: '你参与了几个 DeFi 协议的早期建设，从流动性挖矿到借贷、衍生品。虽然你没当上创始人，但你的建议和代码被写进了历史。后来行业整顿，你退居二线，只做顾问。临终前你说：我们证明过链上可以跑金融，剩下的交给时间。' },
  satoshi_reborn: { title: '中本聪转世', desc: '被戏称为「再世中本」，隐姓埋名至死。', class: 'peak', story: '因为一次技术贡献和行事风格，圈内开始戏称你是「中本聪转世」。你从不承认也不否认，只是继续写代码、发论文、不露面。你从未抛过一枚币，也从未接受过采访。临终前你销毁了所有身份线索，只留下一句话：比特币不属于任何人，包括我。' },
  moon_lambo: { title: '月球兰博', desc: '财富自由后真买了兰博，开车上过热搜。', class: 'peak', story: '你套现后真的买了兰博，还拍了一条「月球兰博」的视频，播放量破亿。后来你把车捐了，说不想被标签绑架。但那句「To the moon」成了一代人的口号。你晚年住在海边，每天看日出，不再提币价，只说：飞过就够了。' },
  rug_puller_jail: { title: '跑路入狱', desc: '发币跑路，最终落网。', class: 'bad', story: '你发了个币，拉盘后卷款跑路，逍遥了几年最终还是落网。庭审时受害者挤满旁听席。你被判了重刑，链上你的项目成了反面教材。出狱时行业早已变了天，没人再认得你。你找了一份普通工作，再也没提过「割韭菜」三个字。' },
  airdrop_tycoon: { title: '空投大亨', desc: '撸遍各大空投，财富自由。', class: 'good', story: '你从早期就开始多钱包撸空投，每个项目你都认真交互。几年下来，几个大毛让你直接财务自由。你从不炫耀，只说运气好。后来你建了一个社群，专门教人如何辨别真空投和骗局。你说：羊毛要撸，但要撸得干净。' },
  memecoin_emperor: { title: '梗币皇帝', desc: '一手打造现象级 Meme 币，名留青史。', class: 'peak', story: '你创造了一个现象级 Meme 币，从社区梗图到上所、拉盘、FOMO，你每一步都踩准了节奏。虽然最后泡沫破了，但你的名字永远和那个符号绑在一起。有人骂你割韭菜，有人说你定义了 Meme 时代。你晚年不再回应，只发过一条推：我们曾一起相信过一只狗。' },
  web3_prophecy: { title: 'Web3 先知', desc: '预言成真，被奉为行业先知。', class: 'peak', story: '你在多年前写的几篇关于 Web3 的预言，后来逐一应验。人们把你奉为先知，每有大事就翻出你的旧文。你从未借机敛财，只是继续写、继续思考。临终前你说：我不是先知，只是愿意相信代码和共识能改变世界。你的账号被永久置顶，成了某种圣经。' },
};

/** 现实类结局按档位分池（90% 从对应档位抽） */
const REALISTIC_TRAGIC = ['beggar', 'debt_suicide', 'debt_fugitive', 'jail', 'mental_collapse', 'betrayed_all', 'destitute', 'die_alone', 'sudden_death', 'cancer_fight', 'homeless_freeze', 'gambling_ruin', 'abuse_depression', 'journalist_killed', 'climber_missing', 'programmer_burnout', 'travel_blogger_death', 'musician_depression', 'alcohol_early_death', 'dementia_forgotten', 'politician_jail', 'divorce_lonely', 'unfilial_nursing_home', 'misdiagnosis', 'stroke_collapse', 'heart_attack', 'eco_hero', 'war_survivor', 'parent_sacrifice', 'athlete_disabled', 'artist_posthumous', 'writer_hermit'];
const REALISTIC_BAD = ['bankruptcy', 'wage_slave_debt', 'back_to_farm', 'quit_forever', 'small_loss_exit', 'rug_puller_jail'];
const REALISTIC_NORMAL = ['nobody', 'exit_ashore', 'forget_hold', 'side_income', 'lurker', 'plain_life', 'worker_retirement_ok'];
const REALISTIC_GOOD = ['small_rich', 'passive_life', 'kol_small', 'early_retire', 'angel_glory', 'peaceful_old_age', 'family_bliss', 'travel_world', 'retire_after_peak', 'charity_remembered', 'mountain_hermit', 'teacher_legacy', 'farmer_land', 'couple_70_same_day', 'scientist_nobel', 'doctor_hero_death', 'chef_empire', 'athlete_empire', 'lottery_late', 'philanthropist_poor', 'inherit_fortune', 'faith_transcendence', 'island_retire', 'airdrop_tycoon'];
const REALISTIC_GREAT = ['freedom', 'mogul', 'kol_top', 'business_boss', 'vc_king', 'billionaire', 'celebrity_legend', 'chain_whale', 'dao_founder', 'nft_king', 'defi_pioneer'];
const REALISTIC_PEAK = ['richest', 'crypto_empire', 'legend', 'satoshi_reborn', 'moon_lambo', 'memecoin_emperor', 'web3_prophecy'];

/** 其他类结局（科幻/离奇，约10% 概率无视档位抽） */
const OTHER_ENDINGS = ['space_explorer', 'mind_upload', 'cyborg_300', 'apocalypse_survivor', 'ai_merge', 'time_traveler', 'mars_settler', 'nano_immortal', 'vr_addict_death', 'space_elevator', 'clone_fusion', 'hacker_ai_wipe', 'probe_lost', 'upload_virus', 'dystopia_suppressed', 'quantum_mad', 'gene_edit_self_aging', 'virtual_idol', 'captain_wormhole', 'alien_ambassador', 'bci_paralyzed', 'wasteland_leader', 'cryo_awake_alone', 'robot_uprising_survivor', 'moon_base_death', 'parallel_lost', 'enhanced_soldier', 'climate_hero_drown', 'space_miner_cancer', 'immortality_assassinated', 'ai_cult_leader', 'deep_sea_rupture', 'vr_admin_trapped', 'antigrav_crash', 'wormhole_trapped', 'grey_goo_sacrifice', 'cyber_hacker_hunted', 'star_war_veteran'];

const OTHER_ENDING_CHANCE = 0.1;

/** 稀有度：白(common) 绿(uncommon) 蓝(rare) 紫(epic) 橙(legendary) 红(mythic) 金(supreme)。结局大标题颜色按此。 */
const RARITIES = ['common', 'uncommon', 'rare', 'epic', 'legendary', 'mythic', 'supreme'];

/** 各档位下抽到某稀有度的权重（越惨越容易出白绿，越富越容易出紫橙红金） */
const RARITY_WEIGHTS_BY_TIER = {
  tragic: { common: 0.52, uncommon: 0.30, rare: 0.12, epic: 0.04, legendary: 0.02, mythic: 0, supreme: 0 },
  bad:    { common: 0.48, uncommon: 0.32, rare: 0.12, epic: 0.06, legendary: 0.02, mythic: 0, supreme: 0 },
  normal: { common: 0.35, uncommon: 0.35, rare: 0.20, epic: 0.07, legendary: 0.02, mythic: 0.01, supreme: 0 },
  good:   { common: 0.08, uncommon: 0.27, rare: 0.32, epic: 0.22, legendary: 0.08, mythic: 0.02, supreme: 0.01 },
  great:  { common: 0,    uncommon: 0.05, rare: 0.18, epic: 0.30, legendary: 0.28, mythic: 0.14, supreme: 0.05 },
  peak:   { common: 0,    uncommon: 0,    rare: 0.05, epic: 0.12, legendary: 0.28, mythic: 0.33, supreme: 0.22 },
  weird:  { common: 0.05, uncommon: 0.12, rare: 0.23, epic: 0.28, legendary: 0.20, mythic: 0.08, supreme: 0.04 },
};

/** 每个结局的稀有度（用于抽选与标题颜色） */
const ENDING_RARITY = {
  beggar: 'common', debt_suicide: 'uncommon', debt_fugitive: 'common', jail: 'uncommon', mental_collapse: 'common', betrayed_all: 'uncommon', pig_butchering: 'uncommon', destitute: 'common', die_alone: 'common', sudden_death: 'common', cancer_fight: 'uncommon', homeless_freeze: 'common', gambling_ruin: 'uncommon', abuse_depression: 'common', journalist_killed: 'rare', climber_missing: 'uncommon', programmer_burnout: 'common', travel_blogger_death: 'uncommon', musician_depression: 'uncommon', alcohol_early_death: 'common', dementia_forgotten: 'common', politician_jail: 'uncommon', divorce_lonely: 'common', unfilial_nursing_home: 'common', misdiagnosis: 'common', stroke_collapse: 'common', heart_attack: 'common', eco_hero: 'rare', war_survivor: 'uncommon', parent_sacrifice: 'common', athlete_disabled: 'uncommon', artist_posthumous: 'rare', writer_hermit: 'uncommon',
  bankruptcy: 'common', wage_slave_debt: 'common', back_to_farm: 'common', quit_forever: 'uncommon', small_loss_exit: 'common',
  nobody: 'common', exit_ashore: 'uncommon', forget_hold: 'common', side_income: 'common', lurker: 'common', plain_life: 'uncommon', worker_retirement_ok: 'common',
  small_rich: 'uncommon', passive_life: 'rare', kol_small: 'uncommon', early_retire: 'rare', angel_glory: 'rare', peaceful_old_age: 'rare', family_bliss: 'uncommon', travel_world: 'rare', retire_after_peak: 'epic', charity_remembered: 'epic', mountain_hermit: 'uncommon', teacher_legacy: 'rare', farmer_land: 'uncommon', couple_70_same_day: 'rare', scientist_nobel: 'epic', doctor_hero_death: 'epic', chef_empire: 'rare', athlete_empire: 'epic', lottery_late: 'uncommon', philanthropist_poor: 'epic', inherit_fortune: 'uncommon', faith_transcendence: 'uncommon', island_retire: 'rare',
  freedom: 'legendary', mogul: 'epic', kol_top: 'epic', business_boss: 'legendary', vc_king: 'legendary', billionaire: 'legendary', celebrity_legend: 'epic',
  richest: 'mythic', crypto_empire: 'mythic', legend: 'supreme',
  space_explorer: 'rare', mind_upload: 'epic', cyborg_300: 'epic', apocalypse_survivor: 'rare', ai_merge: 'legendary', time_traveler: 'legendary', mars_settler: 'epic', nano_immortal: 'epic', vr_addict_death: 'uncommon', space_elevator: 'rare', clone_fusion: 'epic', hacker_ai_wipe: 'legendary', probe_lost: 'rare', upload_virus: 'uncommon', dystopia_suppressed: 'epic', quantum_mad: 'rare', zombie_apocalypse: 'epic', gene_edit_self_aging: 'rare', virtual_idol: 'uncommon', captain_wormhole: 'epic', alien_ambassador: 'epic', bci_paralyzed: 'rare', wasteland_leader: 'rare', cryo_awake_alone: 'rare', robot_uprising_survivor: 'rare', moon_base_death: 'epic', parallel_lost: 'epic', enhanced_soldier: 'rare', climate_hero_drown: 'rare', space_miner_cancer: 'uncommon', immortality_assassinated: 'legendary', ai_cult_leader: 'epic', deep_sea_rupture: 'uncommon', vr_admin_trapped: 'rare', antigrav_crash: 'rare', wormhole_trapped: 'legendary', grey_goo_sacrifice: 'mythic', cyber_hacker_hunted: 'epic', star_war_veteran: 'rare',
  // 新增结局补足紫橙红金
  chain_whale: 'epic', dao_founder: 'legendary', nft_king: 'epic', defi_pioneer: 'legendary', satoshi_reborn: 'supreme', moon_lambo: 'mythic', rug_puller_jail: 'rare', airdrop_tycoon: 'epic', memecoin_emperor: 'mythic', web3_prophecy: 'supreme',
};

/** 按稀有度从池中抽一条结局；先按档位权重 roll 稀有度，再在该稀有度内随机 */
function pickEndingByRarity(pool, tier) {
  const weights = RARITY_WEIGHTS_BY_TIER[tier] || RARITY_WEIGHTS_BY_TIER.normal;
  let r = Math.random();
  let chosenRarity = 'common';
  for (const rarity of RARITIES) {
    r -= weights[rarity] || 0;
    if (r <= 0) { chosenRarity = rarity; break; }
  }
  const filtered = pool.filter(id => (ENDING_RARITY[id] || 'common') === chosenRarity);
  const finalPool = filtered.length > 0 ? filtered : pool;
  return finalPool[Math.floor(Math.random() * finalPool.length)];
}

/** 从池中抽一条结局；约10%概率改为从「其他类」池抽取，且按稀有度权重抽 */
function pickFromPool(pool, tier) {
  const actualTier = tier || 'normal';
  if (Math.random() < OTHER_ENDING_CHANCE && OTHER_ENDINGS.length > 0) {
    return pickEndingByRarity(OTHER_ENDINGS, 'weird');
  }
  return pickEndingByRarity(pool, actualTier);
}

/** 净资产 = 现金 - 负债，用于结局与显示 */
function getNetWealth(state) {
  return (state.wealth || 0) - (state.debt || 0);
}

/** 根据初始设定计算「坏结局倾向」0~1：运气差、理性低、风险偏好高 → 更容易坏/悲剧结局 */
function getTraitBadBias(state) {
  const luck = state.luck != null ? state.luck : 0.5;
  const rationality = state.rationality != null ? state.rationality : 0.5;
  const risk = state.riskPreference != null ? state.riskPreference : 0.5;
  const badBias = (0.5 - luck) * 0.45 + (0.5 - rationality) * 0.35 + (risk - 0.5) * 0.25;
  return Math.max(0, Math.min(1, 0.5 + badBias));
}

/** 根据状态或强制ID得到人生结局ID（用于 endGame 展示）. 悲惨/坏结局只有「亏完」才合理，有几十万不算惨。 */
function getLifeEndingId(state, forcedId) {
  const w = getNetWealth(state);
  const badBias = getTraitBadBias(state);

  if (forcedId && LIFE_ENDINGS[forcedId]) return forcedId;
  if (state.ending && LIFE_ENDINGS[state.ending]) return state.ending;
  // 彩蛋：1% 概率触发丧尸末日（任意资产都可能抽到）
  if (Math.random() < 0.01) return 'zombie_apocalypse';

  function rollBadVsTragic(tragicChance) {
    return Math.random() < tragicChance ? pickFromPool(REALISTIC_TRAGIC, 'tragic') : pickFromPool(REALISTIC_BAD, 'bad');
  }
  function rollBadVsNormal(badChance) {
    return Math.random() < badChance ? pickFromPool(REALISTIC_BAD, 'bad') : pickFromPool(REALISTIC_NORMAL, 'normal');
  }

  // ========== 只有 0 或负资产才出悲惨/坏结局 ==========
  if (w <= 0) {
    return rollBadVsTragic(0.5 + badBias * 0.4);
  }

  // ========== 0～20 万：普通、好 ==========
  if (w <= 200000) {
    return Math.random() < (0.4 + badBias * 0.2) ? pickFromPool(REALISTIC_GOOD, 'good') : pickFromPool(REALISTIC_NORMAL, 'normal');
  }
  // ========== 20 万～300 万：好 ==========
  if (w <= 3e6) {
    return pickFromPool(REALISTIC_GOOD, 'good');
  }
  // ========== 300 万～5000 万：大成 ==========
  if (w <= 5e7) {
    return pickFromPool(REALISTIC_GREAT, 'great');
  }
  // ========== 大于 5000 万：大成、巅峰 ==========
  return Math.random() < 0.5 ? pickFromPool(REALISTIC_GREAT, 'great') : pickFromPool(REALISTIC_PEAK, 'peak');
}

let game = {
  running: false,
  paused: false,
  speed: 5,
  tickInterval: null,
  state: null,
  marketHistory: [],
  marketPhase: 'sideway',
  marketTicksLeft: 0,
  lastRunSummary: null,
};

function getDefaultState() {
  return {
    capital: 1000,
    wealth: 1000,
    debt: 0,                       // 负债（借钱/亏损转债时增加），结算时还清按净资产算
    fans: 0,
    exp: 0,
    year: 0,
    week: 0,
    mainPath: 'kol',
    pathWeights: { kol: 1, job: 0, trading: 0, launch: 0, invest: 0, staking: 0, airdrop: 0 },
    passiveIncomePerYear: 0,
    runPassiveMult: 0.88 + Math.random() * 0.24, // 每局 0.88~1.12，拉大被动收入差异
    runRiskRewardMult: 1 + 9 * Math.pow(Math.random(), 2), // 每局 1～10，小数概率大（偏 1～3），收益亏损都乘此系数
    eventLog: [],
    usedScamTypes: [], // 本局已出现过的诈骗套路，同套路只出现一次
    ended: false,
    ending: null,
    luck: 0.5,
    social: 0.5,
    rationality: 0.5,
    strategy: 0.5,
    riskPreference: 0.5,
    hadWindfall100: false,
    hadWindfall1000: false,
    hadCatastrophe: false,
    playerId: '',
  };
}

const PATH_IDS = ['kol', 'job', 'trading', 'launch', 'invest', 'staking', 'airdrop'];

/** 根据人物设定计算各路径的权重（0~1），用于加权随机抽一条路径 */
function computePathWeights(traits) {
  const luck = traits.luck != null ? traits.luck : 0.5;
  const social = traits.social != null ? traits.social : 0.5;
  const rationality = traits.rationality != null ? traits.rationality : 0.5;
  const strategy = traits.strategy != null ? traits.strategy : 0.5;
  const risk = traits.riskPreference != null ? traits.riskPreference : 0.5;
  return {
    kol:    social * 0.7 + (1 - rationality) * 0.3 + luck * 0.2,
    job:    social * 0.4 + rationality * 0.5 + (1 - risk) * 0.4 + strategy * 0.2,
    trading: (1 - social) * 0.5 + (1 - rationality) * 0.3 + risk * 0.5 + (1 - strategy) * 0.4,
    launch: risk * 0.5 + social * 0.5,
    invest: rationality * 0.5 + strategy * 0.6 + social * 0.2,
    staking: rationality * 0.4 + (1 - risk) * 0.5 + (1 - social) * 0.2,
    airdrop: strategy * 0.4 + luck * 0.3 + rationality * 0.2,
  };
}

/** 按权重加权随机抽一条路径 */
function pickPathByWeights(weights) {
  const ids = PATH_IDS;
  let total = 0;
  ids.forEach(id => { total += Math.max(0, weights[id] || 0) + 0.05; });
  let r = Math.random() * total;
  for (const id of ids) {
    r -= Math.max(0, weights[id] || 0) + 0.05;
    if (r <= 0) return id;
  }
  return ids[ids.length - 1];
}

function startNewGame(initCapital, traits) {
  const speedEl = document.getElementById('speedSelect');
  if (speedEl) game.speed = Math.max(1, Math.min(100, parseInt(speedEl.value, 10) || 5));
  const weights = computePathWeights(traits || {});
  const path = pickPathByWeights(weights);
  const state = getDefaultState();
  const playerIdInput = document.getElementById('initPlayerId');
  state.playerId = (playerIdInput && playerIdInput.value) ? String(playerIdInput.value).trim().slice(0, 32) : '';
  state.capital = Math.max(1000, Math.min(50000, initCapital));
  state.wealth = state.capital;
  state.debt = 0;
  state.mainPath = path;
  state.pathWeights = PATH_IDS.reduce((o, id) => ({ ...o, [id]: id === path ? 1 : 0 }), {});
  state.luck = traits && traits.luck != null ? traits.luck : 0.5;
  state.social = traits && traits.social != null ? traits.social : 0.5;
  state.rationality = traits && traits.rationality != null ? traits.rationality : 0.5;
  state.strategy = traits && traits.strategy != null ? traits.strategy : 0.5;
  state.riskPreference = traits && traits.riskPreference != null ? traits.riskPreference : 0.5;
  // 该路径 5% 先天圣体（全正面）、5% 倒霉圣体（全负面+一直借钱）
  const saintRoll = Math.random();
  if (saintRoll < 0.05) state.pathSaint = 'blessed';
  else if (saintRoll < 0.10) state.pathSaint = 'cursed';
  else state.pathSaint = null;
  game.state = state;
  game.running = true;
  game.marketPhase = MARKET_PHASES[Math.floor(Math.random() * MARKET_PHASES.length)];
  game.marketTicksLeft = MARKET_DURATION_MIN + Math.floor(Math.random() * (MARKET_DURATION_MAX - MARKET_DURATION_MIN));
  game.marketHistory = [0.5 + Math.random() * 0.5];
  game.state.marketPhase = game.marketPhase;
  // 开局第一条日志：玩家ID（若有）+ 路径选择叙事 + 圣体提示
  let firstLogText = PATH_FIRST_LOG[path];
  if (state.playerId) firstLogText = '玩家 ' + state.playerId + ' 入圈。' + firstLogText;
  if (state.pathSaint === 'blessed') firstLogText = '【先天圣体】' + firstLogText + ' 本路径气运加身，遇事多成。';
  else if (state.pathSaint === 'cursed') firstLogText = '【倒霉圣体】' + firstLogText + ' 本路径命犯太岁，遇事多亏。';
  state.eventLog.unshift({ time: '第1年1月', text: firstLogText, type: state.pathSaint === 'blessed' ? 'positive' : state.pathSaint === 'cursed' ? 'negative' : 'positive', netWealth: getNetWealth(state) });
  game.paused = false;
  const btnPause = document.getElementById('btnPause');
  if (btnPause) { btnPause.style.display = ''; btnPause.textContent = '⏸ 暂停'; }
  updateUI();
  renderLog();
  runTick();
  startTickLoop();
}

function startTickLoop() {
  if (game.tickInterval) clearInterval(game.tickInterval);
  const speed = Math.max(1, Math.min(100, game.speed || 1));
  const ms = Math.max(50, Math.floor(MS_PER_TICK / speed));
  game.tickInterval = setInterval(() => {
    if (!game.running || (game.state && game.state.ended)) {
      clearInterval(game.tickInterval);
      return;
    }
    runTick();
  }, ms);
}

function runTick() {
  if (game.paused) return;
  const s = game.state;
  if (!s || s.ended) return;

  // 已满五年（第5年12月）则直接结账，不再推进时间，避免出现「第6年」日志
  if (s.year >= MAX_YEARS - 1 && s.week >= TICKS_PER_YEAR - 1) {
    endGame('time_up');
    return;
  }
  const isLastMonth = (s.year === MAX_YEARS - 1 && s.week === TICKS_PER_YEAR - 2);
  // 时间推进：1 tick = 1 月
  s.week++;
  if (s.week >= TICKS_PER_YEAR) {
    s.week = 0;
    s.year++;
  }
  s.marketPhase = game.marketPhase;

  // 市场相位更新
  game.marketTicksLeft--;
  if (game.marketTicksLeft <= 0) {
    const next = MARKET_PHASES[Math.floor(Math.random() * MARKET_PHASES.length)];
    game.marketPhase = next;
    game.marketTicksLeft = MARKET_DURATION_MIN + Math.floor(Math.random() * (MARKET_DURATION_MAX - MARKET_DURATION_MIN));
  }
  let trend = 0;
  if (game.marketPhase === 'bull') trend = 0.02;
  if (game.marketPhase === 'bear') trend = -0.02;
  const last = game.marketHistory[game.marketHistory.length - 1];
  const nextVal = Math.max(0.1, Math.min(0.95, last + trend + (Math.random() - 0.5) * 0.05));
  game.marketHistory.push(nextVal);
  if (game.marketHistory.length > 80) game.marketHistory.shift();

  // 被动收入压得很低，确保多数对局会亏/平；每局用 runPassiveMult 拉大差异
  const pathIncome = { kol: 1.2, job: 2.2, trading: 0.3, launch: 0.6, invest: 1, staking: 2, airdrop: 0.3 };
  const pathContrib = pathIncome[s.mainPath] != null ? pathIncome[s.mainPath] : 0.8;
  const runMult = (s.runPassiveMult != null ? s.runPassiveMult : 1);
  s.passiveIncomePerYear = pathContrib * (1 + s.exp / 1600) * runMult;
  const monthIncome = (s.passiveIncomePerYear / TICKS_PER_YEAR) * (game.marketPhase === 'bull' ? 1.2 : game.marketPhase === 'bear' ? 0.8 : 1);
  s.wealth += monthIncome;
  s.capital = Math.max(0, s.capital + monthIncome * 0.5);

  // 每月必触发一个事件；0.01% 千倍、0.1% 百倍暴富
  const windfallRoll = Math.random();
  if (windfallRoll < 0.0001 && (s.wealth || 0) > 0) {
    s.hadWindfall1000 = true;
    const stake = Math.min(s.wealth || 0, 50000);
    const gain = stake * 999;
    s.wealth += gain;
    s.capital = Math.max(0, (s.capital || 0) + gain * 0.5);
    const coin = typeof getRandomCoin === 'function' ? getRandomCoin() : 'BTC';
    pushLog(
      { name: '千倍暴富', type: 'positive', logTemplate: '天降横财，一笔仓位千倍回报，+{amount} U。' },
      null,
      { gain, coin, fansDelta: 0 }
    );
  } else if (windfallRoll < 0.001 && (s.wealth || 0) > 0) {
    s.hadWindfall100 = true;
    const stake = Math.min(s.wealth || 0, 50000);
    const gain = stake * 99;
    s.wealth += gain;
    s.capital = Math.max(0, (s.capital || 0) + gain * 0.5);
    const coin = typeof getRandomCoin === 'function' ? getRandomCoin() : 'BTC';
    pushLog(
      { name: '百倍暴富', type: 'positive', logTemplate: '天降横财，一笔仓位百倍回报，+{amount} U。' },
      null,
      { gain, coin, fansDelta: 0 }
    );
  } else {
    // 0.5% 概率遭遇暴雷：资产降低 80%～150%（超过 100% 部分变为负债），随机一种负面叙事
    const catastropheRoll = Math.random();
    const totalAssets = (s.wealth || 0) + (s.capital || 0);
    if (catastropheRoll < 0.005 && totalAssets > 0) {
      s.hadCatastrophe = true;
      const lossPct = 0.8 + Math.random() * 0.7; // 80% ~ 150%
      const lossAmount = totalAssets * lossPct;
      let remaining = lossAmount;
      if ((s.wealth || 0) >= remaining) {
        s.wealth -= remaining;
        remaining = 0;
      } else {
        remaining -= (s.wealth || 0);
        s.wealth = 0;
      }
      if (remaining > 0 && (s.capital || 0) > 0) {
        const fromCap = Math.min(s.capital, remaining);
        s.capital -= fromCap;
        remaining -= fromCap;
      }
      if (remaining > 0) s.debt = (s.debt || 0) + remaining;
      const catEv = CATASTROPHE_EVENTS[Math.floor(Math.random() * CATASTROPHE_EVENTS.length)];
      pushLog(
        { name: catEv.name, type: 'negative', logTemplate: catEv.logTemplate },
        null,
        { loss: Math.round(lossAmount), gain: 0, fansDelta: 0, coin: typeof getRandomCoin === 'function' ? getRandomCoin() : 'BTC' }
      );
    } else if (typeof pickRandomEvent === 'function') {
      const ev = pickRandomEvent(s);
      if (ev) triggerEvent(ev);
    }
  }

  // 最后一个月且总资产低于 100 万：50% 概率资产亏完或负债
  if (isLastMonth && getNetWealth(s) < 1e6 && Math.random() < 0.5) {
    const netBefore = getNetWealth(s);
    const wipeOut = netBefore > 0 ? '归零' : '雪上加霜';
    if (Math.random() < 0.65) {
      s.wealth = 0;
      s.capital = 0;
    } else {
      s.wealth = 0;
      s.capital = 0;
      const debtAdd = 20000 + Math.floor(Math.random() * 80000);
      s.debt = (s.debt || 0) + debtAdd;
    }
    const timeStr = `第${s.year + 1}年${s.week + 1}月`;
    s.eventLog.unshift({ time: timeStr, text: `最后一月暴雷，资产${wipeOut}。`, type: 'negative', netWealth: getNetWealth(s) });
    if (s.eventLog.length > 500) s.eventLog.pop();
    renderLog();
  }

  // 游戏结束条件：仅 A10 或 跑满五年（财富归零/负资产不结束，可负债跑完）
  if (s.wealth >= A10) {
    endGame('freedom');
    return;
  }
  if (s.year >= MAX_YEARS) {
    endGame('time_up');
    return;
  }
  updateUI();
}

function triggerEvent(ev) {
  const s = game.state;
  if (s.ended) return;

  if (ev.type === 'mixed' && ev.choices && ev.choices.length) {
    resolveMixedEventAuto(ev);
    return;
  }

  const result = applyEventEffect(ev);
  if (ev.scamType && game.state.usedScamTypes && !game.state.usedScamTypes.includes(ev.scamType)) {
    game.state.usedScamTypes.push(ev.scamType);
  }
  pushLog(ev, null, result);
  updateUI();
}

/** 混合事件按开局设定自动选分支，不弹窗 */
function resolveMixedEventAuto(ev) {
  const s = game.state;
  const rationality = s.rationality != null ? s.rationality : 0.5;
  const riskPreference = s.riskPreference != null ? s.riskPreference : 0.5;
  const luck = s.luck != null ? s.luck : 0.5;
  const choices = ev.choices || [];
  if (choices.length === 0) {
    applyEventEffect(ev);
    pushLog(ev, null);
    updateUI();
    return;
  }
  const scores = choices.map((c, i) => {
    // 杀猪盘等直接导致悲剧结局的选项：理性低+运气差时权重明显上升
    if (c.specialEnding) {
      return 0.002 + (1 - rationality) * 0.012 + (0.5 - luck) * 0.008;
    }
    const isRisky = (c.effect && (c.effect.capitalPct < 0)) || (c.effect === 'random' && c.effects && c.effects.some(e => e.capitalPct < 0));
    let score = 0.5;
    if (isRisky) score = (1 - rationality) * (0.55 + riskPreference * 0.5) + (0.5 - luck) * 0.15;
    else score = 0.25 + rationality * 0.55 + luck * 0.25;
    return Math.max(0.01, score);
  });
  const total = scores.reduce((a, b) => a + b, 0);
  let r = Math.random() * total;
  let choiceIndex = 0;
  for (let i = 0; i < scores.length; i++) {
    r -= scores[i];
    if (r <= 0) { choiceIndex = i; break; }
    choiceIndex = i;
  }
  const { outcome: outcomeText, result } = applyEventEffect(ev, choiceIndex) || {};
  const chosen = choices[choiceIndex];
  const badOutcome = chosen && (chosen.specialEnding || (chosen.effect && typeof chosen.effect === 'object' && chosen.effect.capitalPct < 0));
  if (ev.scamType && badOutcome && game.state.usedScamTypes && !game.state.usedScamTypes.includes(ev.scamType)) {
    game.state.usedScamTypes.push(ev.scamType);
  }
  const reason = rationality >= 0.6 ? '理性较高' : riskPreference >= 0.6 ? '偏好冒险' : '随势而动';
  const outcome = outcomeText != null ? outcomeText : (choices[choiceIndex] && choices[choiceIndex].outcome);
  pushLog(ev, outcome ? `${outcome}（${reason}）` : reason, result);
  updateUI();
}

function applyEventEffect(ev, choiceIndex) {
  const s = game.state;
  const result = { gain: 0, loss: 0, fansDelta: 0, coin: typeof getRandomCoin === 'function' ? getRandomCoin() : 'BTC' };
  if (ev.bigNamePool && ev.bigNamePool.length) result.bigName = ev.bigNamePool[Math.floor(Math.random() * ev.bigNamePool.length)];
  const rarityMult = typeof getRarityMultiplier === 'function' ? getRarityMultiplier(ev) : 1;
  const maxExposure = typeof getMaxExposure === 'function' ? getMaxExposure(ev) : 1e9;
  const pathSaint = s.pathSaint || null;
  const runRR = Math.max(0.1, (s.runRiskRewardMult != null ? s.runRiskRewardMult : 1));
  // 先天圣体：收益不封顶，全仓滚雪球，才能钱滚钱冲 A10
  const effectiveWealth = (pathSaint === 'blessed') ? (s.wealth || 0) : Math.min(s.wealth || 0, maxExposure);
  const effectiveCapital = Math.min(s.capital || 0, maxExposure);
  const saintGainMult = pathSaint === 'blessed' ? 2.0 : pathSaint === 'cursed' ? 0.5 : 1;
  const saintLossMult = pathSaint === 'blessed' ? 0.45 : pathSaint === 'cursed' ? 1.4 : 1;

  function applyGain(gain) {
    if (gain <= 0) return;
    let g = gain * saintGainMult * runRR;
    const luck = s.luck != null ? s.luck : 0.5;
    const luckMultiplier = 0.72 + luck * 0.32;
    const scaledGain = g * Math.max(0.65, Math.min(1.05, luckMultiplier));
    result.gain += scaledGain;
    s.wealth += scaledGain;
    s.capital = Math.max(0, s.capital + scaledGain * 0.5);
  }
  function applyLoss(loss) {
    if (loss <= 0) return;
    let L = loss * saintLossMult * runRR;
    const luck = s.luck != null ? s.luck : 0.5;
    const luckMultiplier = 1 + (0.5 - luck) * 0.75;
    const scaledLoss = L * Math.max(0.85, Math.min(1.4, luckMultiplier));
    const capped = Math.min(scaledLoss, (s.capital || 0) * MAX_LOSS_PCT);
    result.loss += capped;
    s.capital = Math.max(0, (s.capital || 0) - capped);
    const wealthDeduction = capped * 0.8;
    if ((s.wealth || 0) < wealthDeduction) {
      s.debt = (s.debt || 0) + (wealthDeduction - s.wealth);
      s.wealth = 0;
    } else {
      s.wealth -= wealthDeduction;
    }
  }
  function applyFans(delta) {
    if (delta !== 0) result.fansDelta += delta;
    s.fans = Math.max(0, s.fans + delta);
  }

  if (choiceIndex !== undefined && ev.choices && ev.choices[choiceIndex]) {
    const choice = ev.choices[choiceIndex];
    let effectToApply = choice.effect;
    let outcomeToShow = choice.outcome;
    if (choice.effect === 'random' && choice.effects && choice.effects.length) {
      const weights = choice.weight || choice.effects.map(() => 1);
      const total = weights.reduce((a, b) => a + b, 0);
      let r = Math.random() * total;
      let idx = 0;
      for (let i = 0; i < weights.length; i++) {
        r -= weights[i];
        if (r <= 0) { idx = i; break; }
        idx = i;
      }
      effectToApply = choice.effects[idx];
      outcomeToShow = (choice.outcomes && choice.outcomes[idx]) || choice.outcome;
    }
    if (effectToApply && typeof effectToApply === 'object') {
      if (effectToApply.wealthPct) applyGain(effectiveWealth * effectToApply.wealthPct * rarityMult);
      if (effectToApply.wealthAbs) {
        const r = effectToApply.wealthAbs;
        const add = (r[0] + Math.random() * (r[1] - r[0])) * rarityMult;
        applyGain(add);
      }
      if (effectToApply.capitalPct != null && effectToApply.capitalPct < 0) {
        const loss = effectiveCapital * Math.min(1, -effectToApply.capitalPct) * rarityMult;
        applyLoss(loss);
      }
      if (effectToApply.fansPct) applyFans(Math.floor(s.fans * effectToApply.fansPct));
      if (effectToApply.fansAbs) applyFans(effectToApply.fansAbs);
      if (effectToApply.debtAdd != null) {
        const raw = typeof effectToApply.debtAdd === 'number' ? effectToApply.debtAdd : (effectToApply.debtAdd[0] + Math.random() * (effectToApply.debtAdd[1] - effectToApply.debtAdd[0]));
        const add = raw * rarityMult;
        s.debt = (s.debt || 0) + add;
        result.debtAdd = add;
      }
    }
    if (choice.specialEnding) endGame(choice.specialEnding);
    return { outcome: outcomeToShow, result };
  }

  if (ev.wealthPct) applyGain(effectiveWealth * ev.wealthPct * rarityMult);
  if (ev.wealthAbs) {
    const range = Array.isArray(ev.wealthAbs) ? ev.wealthAbs : [ev.wealthAbs, ev.wealthAbs];
    applyGain((range[0] + Math.random() * (range[1] - range[0])) * rarityMult);
  }
  if (ev.capitalPct != null && ev.capitalPct < 0) {
    const loss = Math.min(effectiveCapital * Math.min(1, -ev.capitalPct) * rarityMult, (s.capital || 0) * MAX_LOSS_PCT);
    applyLoss(loss);
  }
  if (ev.fansPct) applyFans(Math.floor(s.fans * ev.fansPct));
  if (ev.fansAbs) applyFans(ev.fansAbs || 0);
  if (ev.exp) s.exp += ev.exp;

  if (ev.specialEnding) endGame(ev.specialEnding);
  if (ev.debtAdd != null) {
    const raw = typeof ev.debtAdd === 'number' ? ev.debtAdd : (ev.debtAdd[0] + Math.random() * (ev.debtAdd[1] - ev.debtAdd[0]));
    const add = raw * rarityMult;
    s.debt = (s.debt || 0) + add;
    result.debtAdd = add;
  }
  if (s.wealth >= A10) endGame('freedom');
  return result;
}

function pushLog(ev, outcome, result) {
  const s = game.state;
  const timeStr = `第${s.year + 1}年${s.week + 1}月`;
  let text;
  if (ev.logTemplate && result) {
    const coinDisplay = typeof getCoinDisplayName === 'function' ? getCoinDisplayName(result.coin) : (result.coin || 'BTC');
    text = ev.logTemplate
      .replace(/\{amount\}/g, formatU(result.gain || 0))
      .replace(/\{loss\}/g, formatU(result.loss || 0))
      .replace(/\{debtAdd\}/g, formatU(result.debtAdd || 0))
      .replace(/\{fans\}/g, String(result.fansDelta != null ? result.fansDelta : 0))
      .replace(/\{coin\}/g, coinDisplay)
      .replace(/\{bigName\}/g, result.bigName || '大佬');
  } else {
    const parts = [ev.name];
    if (outcome) parts.push(' → ' + outcome);
    if (result && (result.gain > 0 || result.loss > 0)) parts.push(result.gain > 0 ? '，收益 +' + formatU(result.gain) + ' U' : '，亏损 ' + formatU(result.loss) + ' U');
    text = parts.join('');
  }
  s.eventLog.unshift({ time: timeStr, text, type: ev.type || 'negative', netWealth: getNetWealth(s) });
  if (s.eventLog.length > 500) s.eventLog.pop();
  renderLog();
}

function renderLog() {
  const s = game.state;
  if (!s) return;
  const el = document.getElementById('eventLog');
  el.innerHTML = s.eventLog.map(e => {
    const netStr = e.netWealth != null ? formatU(e.netWealth) + ' U' : '—';
    return `<div class="log-entry ${e.type}"><span class="log-net">${netStr}</span><span class="time">${e.time}</span>${e.text}</div>`;
  }).join('');
}

/** 根据当前财富选取结局故事：有 storyRich/storyPoor 时按净资产选，否则用 story */
function getEndingStory(e, state) {
  const w = getNetWealth(state);
  if (e.title === '丧尸末日') {
    if (e.storyPeak && w >= 5e7) return e.storyPeak;
    if (e.storyRich && w >= 200000) return Math.random() < 0.5 ? e.storyRich : (e.storyRichNoStock || e.storyRich);
    if (e.story && w > 0) return e.story;
    if (e.storyPoor && w <= 0) return e.storyPoor;
    return e.story || e.storyPoor || e.desc;
  }
  if (e.storyRich && w >= 300000) return e.storyRich;
  if (e.storyPoor && w < 80000) return e.storyPoor;
  return e.story || e.desc;
}

function endGame(endingId) {
  const s = game.state;
  if (s.ended) return;
  s.ended = true;
  game.running = false;
  if (game.tickInterval) clearInterval(game.tickInterval);

  // 通用触发（财富自由/破产/时间到）不固定结局，从结局池按状态抽一个故事性结局
  const legacyToLife = { pig: 'pig_butchering' };
  const genericTriggers = ['freedom', 'bankruptcy', 'time_up', 'exit'];
  let lifeId;
  if (genericTriggers.includes(endingId)) {
    s.ending = null;
    lifeId = getLifeEndingId(s, null);
  } else {
    lifeId = legacyToLife[endingId] || endingId;
    if (!LIFE_ENDINGS[lifeId]) {
      s.ending = null;
      lifeId = getLifeEndingId(s, null);
    }
  }
  s.ending = lifeId;

  const e = LIFE_ENDINGS[lifeId] || LIFE_ENDINGS.bankruptcy;
  const storyText = getEndingStory(e, s);
  const netW = getNetWealth(s);
  saveGameHistory({ title: e.title, desc: e.desc, story: storyText, wealth: netW, debt: 0, fans: s.fans, year: s.year, week: s.week, path: s.mainPath, playerId: s.playerId || '', eventLog: (s.eventLog || []).slice() });
  const rarity = ENDING_RARITY[lifeId] || 'common';
  const rawStory = getEndingStory(e, s);
  const storyFormatted = rawStory.replace(/([。！？])/g, '$1\n\n').trim();
  const payload = buildAchievementPayload(s);
  const counts = updateCounts(netW) || getCounts();
  payload.gamesFinished = counts.gamesFinished || 0;
  payload.countWealth1e7 = counts.wealth1e7 || 0;
  payload.countWealth1e8 = counts.wealth1e8 || 0;
  payload.countWealth1e9 = counts.wealth1e9 || 0;
  const unlockedIds = checkAndUnlockAchievements(payload);
  const unlockedAchievementObjs = unlockedIds.map(id => ACHIEVEMENTS.find(a => a.id === id)).filter(Boolean);
  game.lastRunSummary = {
    title: e.title,
    desc: e.desc,
    story: storyFormatted,
    eventLog: (s.eventLog || []).slice(),
    unlockedThisRun: unlockedAchievementObjs,
    wealth: netW,
    year: s.year,
    week: s.week,
    path: s.mainPath,
    playerId: s.playerId || '',
  };
  renderAchievements();
  showEndingScreen(e.title, storyFormatted, netW, rarity, unlockedAchievementObjs);
  document.getElementById('endingScreen').classList.add('show');
  const btnPause = document.getElementById('btnPause');
  if (btnPause) btnPause.style.display = 'none';
}

function showEndingScreen(title, storyFormatted, netW, rarity, unlockedObjs) {
  const box = document.getElementById('endingBox');
  const titleEl = document.getElementById('endingTitle');
  const descEl = document.getElementById('endingDesc');
  const unEl = document.getElementById('endingUnlocked');
  const playerIdEl = document.getElementById('endingPlayerId');
  if (box) box.className = 'ending-box rarity-' + rarity;
  if (titleEl) titleEl.textContent = title + ' · ' + formatU(netW) + ' U';
  if (playerIdEl) {
    const pid = (game.state && game.state.playerId) ? String(game.state.playerId).trim() : '';
    if (pid) { playerIdEl.textContent = '玩家 ID: ' + pid; playerIdEl.style.display = 'block'; } else { playerIdEl.style.display = 'none'; playerIdEl.textContent = ''; }
  }
  if (descEl) descEl.textContent = storyFormatted;
  if (unEl) {
    if (!unlockedObjs || unlockedObjs.length === 0) {
      unEl.style.display = 'none';
      unEl.innerHTML = '';
    } else {
      unEl.style.display = 'block';
      unEl.innerHTML = '<h4>本局解锁成就</h4>' + unlockedObjs.map(a => '<div class="ach-item">' + escapeHtml(a.name) + '：' + escapeHtml(a.desc || '') + '</div>').join('');
    }
  }
}

/** 成就：id, name, desc, rarity, check(payload)；payload 为当局结束时 { netWealth, fans, path, endingId, year, week, hadWindfall100, hadWindfall1000, hadCatastrophe, pathSaint, debt } */
const ACHIEVEMENTS = [
  { id: 'wealth_1m', name: '百万富翁', desc: '单局净资产达到 100 万 U', rarity: 'rare', check: p => Number(p.netWealth) >= 1e6 },
  { id: 'wealth_10m', name: '千万大佬', desc: '单局净资产达到 1000 万 U', rarity: 'epic', check: p => Number(p.netWealth) >= 1e7 },
  { id: 'wealth_100m', name: '亿万身家', desc: '单局净资产达到 1 亿 U', rarity: 'legendary', check: p => Number(p.netWealth) >= 1e8 },
  { id: 'wealth_1b', name: '十亿身家', desc: '单局净资产达到 10 亿 U', rarity: 'mythic', check: p => Number(p.netWealth) >= 1e9 },
  { id: 'wealth_50m', name: '五千万', desc: '单局净资产达到 5000 万 U', rarity: 'epic', check: p => Number(p.netWealth) >= 5e7 },
  { id: 'fans_100k', name: '小有名气', desc: '单局粉丝达到 10 万', rarity: 'uncommon', check: p => Number(p.fans) >= 1e5 },
  { id: 'fans_500k', name: '大 V', desc: '单局粉丝达到 50 万', rarity: 'rare', check: p => Number(p.fans) >= 5e5 },
  { id: 'fans_1m', name: '顶流', desc: '单局粉丝达到 100 万', rarity: 'epic', check: p => Number(p.fans) >= 1e6 },
  { id: 'path_kol', name: 'KOL 之路', desc: '以 KOL 博主路径完成一局', rarity: 'common', check: p => p.path === 'kol' },
  { id: 'path_job', name: '打工人', desc: '以项目打工路径完成一局', rarity: 'common', check: p => p.path === 'job' },
  { id: 'path_trading', name: '炒币成瘾', desc: '以炒币路径完成一局', rarity: 'common', check: p => p.path === 'trading' },
  { id: 'path_launch', name: '发币人', desc: '以发币/撸土狗路径完成一局', rarity: 'common', check: p => p.path === 'launch' },
  { id: 'path_invest', name: '投资人', desc: '以投项目路径完成一局', rarity: 'common', check: p => p.path === 'invest' },
  { id: 'path_staking', name: '躺赚党', desc: '以质押/DeFi 路径完成一局', rarity: 'common', check: p => p.path === 'staking' },
  { id: 'path_airdrop', name: '撸毛党', desc: '以撸空投路径完成一局', rarity: 'common', check: p => p.path === 'airdrop' },
  { id: 'ending_freedom', name: '财富自由', desc: '达成财富自由结局', rarity: 'legendary', check: p => p.endingId === 'freedom' },
  { id: 'ending_satoshi', name: '中本再世', desc: '达成中本聪转世结局', rarity: 'supreme', check: p => p.endingId === 'satoshi_reborn' },
  { id: 'ending_rug', name: '跑路入狱', desc: '达成跑路入狱结局', rarity: 'rare', check: p => p.endingId === 'rug_puller_jail' },
  { id: 'ending_moon_lambo', name: '月球兰博', desc: '达成月球兰博结局', rarity: 'mythic', check: p => p.endingId === 'moon_lambo' },
  { id: 'ending_legend', name: '链上传说', desc: '达成链上传说结局', rarity: 'supreme', check: p => p.endingId === 'legend' },
  { id: 'run_5y', name: '跑满五年', desc: '模拟跑满 5 年再结算', rarity: 'rare', check: p => Number(p.year) >= MAX_YEARS - 1 && Number(p.week) >= TICKS_PER_YEAR - 1 },
  { id: 'bankrupt_1y', name: '一年内破产', desc: '第 1 年内净资产归零或负债', rarity: 'uncommon', check: p => (Number(p.year) === 0 || (Number(p.year) === 1 && Number(p.week) === 0)) && Number(p.netWealth) <= 0 },
  { id: 'catastrophe', name: '黑天鹅幸存', desc: '单局遭遇过 80%～150% 暴雷', rarity: 'uncommon', check: p => p.hadCatastrophe === true },
  { id: 'windfall_100', name: '百倍暴富', desc: '单局触发过百倍暴富', rarity: 'rare', check: p => p.hadWindfall100 === true },
  { id: 'windfall_1000', name: '千倍暴富', desc: '单局触发过千倍暴富', rarity: 'epic', check: p => p.hadWindfall1000 === true },
  { id: 'saint_blessed', name: '先天圣体', desc: '先天圣体状态下完成一局', rarity: 'rare', check: p => p.pathSaint === 'blessed' },
  { id: 'saint_cursed', name: '倒霉圣体', desc: '倒霉圣体状态下完成一局', rarity: 'rare', check: p => p.pathSaint === 'cursed' },
  { id: 'debt_10k', name: '负债累累', desc: '单局负债曾达 10 万 U 以上', rarity: 'uncommon', check: p => Number(p.debt) >= 1e5 },
  { id: 'debt_100k', name: '债台高筑', desc: '单局负债曾达 100 万 U 以上', rarity: 'rare', check: p => Number(p.debt) >= 1e6 },
  { id: 'first_run', name: '初入币圈', desc: '完成第一局模拟', rarity: 'common', check: () => true },
  { id: 'games_5', name: '模拟五局', desc: '累计完成 5 局模拟', rarity: 'common', check: p => Number(p.gamesFinished || 0) >= 5 },
  { id: 'games_10', name: '模拟十局', desc: '累计完成 10 局模拟', rarity: 'uncommon', check: p => Number(p.gamesFinished || 0) >= 10 },
  { id: 'games_20', name: '模拟二十局', desc: '累计完成 20 局模拟', rarity: 'rare', check: p => Number(p.gamesFinished || 0) >= 20 },
  { id: 'games_50', name: '模拟五十局', desc: '累计完成 50 局模拟', rarity: 'epic', check: p => Number(p.gamesFinished || 0) >= 50 },
  { id: 'wealth_1b_5', name: '十亿身家·五回', desc: '累计 5 局净资产达到 10 亿 U', rarity: 'epic', check: p => Number(p.countWealth1e9 || 0) >= 5 },
  { id: 'wealth_1b_10', name: '十亿身家·十回', desc: '累计 10 局净资产达到 10 亿 U', rarity: 'legendary', check: p => Number(p.countWealth1e9 || 0) >= 10 },
  { id: 'wealth_1b_20', name: '十亿身家·二十回', desc: '累计 20 局净资产达到 10 亿 U', rarity: 'mythic', check: p => Number(p.countWealth1e9 || 0) >= 20 },
  { id: 'wealth_100m_5', name: '亿万身家·五回', desc: '累计 5 局净资产达到 1 亿 U', rarity: 'rare', check: p => Number(p.countWealth1e8 || 0) >= 5 },
  { id: 'wealth_100m_10', name: '亿万身家·十回', desc: '累计 10 局净资产达到 1 亿 U', rarity: 'epic', check: p => Number(p.countWealth1e8 || 0) >= 10 },
  { id: 'wealth_10m_5', name: '千万大佬·五回', desc: '累计 5 局净资产达到 1000 万 U', rarity: 'uncommon', check: p => Number(p.countWealth1e7 || 0) >= 5 },
  { id: 'ending_tragic', name: '悲剧收场', desc: '达成任意悲剧类结局', rarity: 'uncommon', check: p => (LIFE_ENDINGS[p.endingId] || {}).class === 'tragic' },
  { id: 'ending_weird', name: '离奇人生', desc: '达成任意离奇/科幻结局', rarity: 'epic', check: p => (LIFE_ENDINGS[p.endingId] || {}).class === 'weird' },
  { id: 'ending_peak', name: '人生巅峰', desc: '达成任意巅峰类结局', rarity: 'legendary', check: p => (LIFE_ENDINGS[p.endingId] || {}).class === 'peak' },
  { id: 'net_negative', name: '资不抵债', desc: '以负净资产结束一局', rarity: 'uncommon', check: p => Number(p.netWealth) < 0 },
  { id: 'zero_fans', name: '路人甲', desc: '以 0 粉丝结束一局', rarity: 'common', check: p => Number(p.fans ?? 0) <= 0 },
  { id: 'gone_zero', name: '归零', desc: '以净资产≤0 结束一局（归零或负债即算）', rarity: 'common', check: p => Number(p.netWealth) <= 0 },
  { id: 'rich_and_famous', name: '又富又红', desc: '单局净资产≥100 万且粉丝≥10 万', rarity: 'epic', check: p => Number(p.netWealth) >= 1e6 && Number(p.fans) >= 1e5 },
  { id: 'early_exit', name: '及时止损', desc: '2 年内达成上岸或小亏离场类结局', rarity: 'rare', check: p => { const y = (Number(p.year) || 0) * TICKS_PER_YEAR + (Number(p.week) || 0); return y <= 24 && ['exit_ashore', 'small_loss_exit', 'quit_forever'].includes(p.endingId); } },
  { id: 'chain_whale_ending', name: '链上巨鲸', desc: '达成链上巨鲸结局', rarity: 'epic', check: p => p.endingId === 'chain_whale' },
  { id: 'dao_founder_ending', name: 'DAO 创始人', desc: '达成 DAO 创始人结局', rarity: 'legendary', check: p => p.endingId === 'dao_founder' },
  { id: 'ending_early_retire', name: '提前退休', desc: '达成提前退休结局', rarity: 'rare', check: p => p.endingId === 'early_retire' },
  { id: 'ending_travel_world', name: '环游世界', desc: '达成环游世界结局', rarity: 'rare', check: p => p.endingId === 'travel_world' },
  { id: 'ending_peaceful_old_age', name: '安享天年', desc: '达成安享天年结局', rarity: 'rare', check: p => p.endingId === 'peaceful_old_age' },
  { id: 'ending_island_retire', name: '海岛余生', desc: '达成海岛余生结局', rarity: 'epic', check: p => p.endingId === 'island_retire' },
  { id: 'ending_charity', name: '公益一生', desc: '达成公益一生被铭记结局', rarity: 'rare', check: p => p.endingId === 'charity_remembered' },
  { id: 'ending_scientist_nobel', name: '诺奖学者', desc: '达成科学家诺奖后低调结局', rarity: 'legendary', check: p => p.endingId === 'scientist_nobel' },
  { id: 'ending_nft_king', name: 'NFT 之王', desc: '达成 NFT 之王结局', rarity: 'epic', check: p => p.endingId === 'nft_king' },
  { id: 'ending_defi_pioneer', name: 'DeFi 先驱', desc: '达成 DeFi 先驱结局', rarity: 'legendary', check: p => p.endingId === 'defi_pioneer' },
  { id: 'ending_memecoin_emperor', name: '梗币皇帝', desc: '达成梗币皇帝结局', rarity: 'mythic', check: p => p.endingId === 'memecoin_emperor' },
  { id: 'ending_airdrop_tycoon', name: '空投大亨', desc: '达成空投大亨结局', rarity: 'epic', check: p => p.endingId === 'airdrop_tycoon' },
  { id: 'ending_good', name: '善终', desc: '达成任意美好类结局', rarity: 'uncommon', check: p => (LIFE_ENDINGS[p.endingId] || {}).class === 'good' },
  { id: 'zero_debt', name: '零负债通关', desc: '以零负债结束一局', rarity: 'rare', check: p => Number(p.debt ?? 0) <= 0 },
  { id: 'bankrupt_3y', name: '三年内破产', desc: '第 3 年内净资产归零或负债', rarity: 'rare', check: p => Number(p.year ?? 0) < 3 && Number(p.netWealth) <= 0 },
  { id: 'ending_mogul', name: '项目大佬', desc: '达成项目大佬结局', rarity: 'epic', check: p => p.endingId === 'mogul' },
  { id: 'ending_richest', name: '首富', desc: '达成首富结局', rarity: 'mythic', check: p => p.endingId === 'richest' },
  { id: 'ending_web3_prophecy', name: 'Web3 预言', desc: '达成 Web3 预言结局', rarity: 'supreme', check: p => p.endingId === 'web3_prophecy' },
  { id: 'ending_angel_glory', name: '天使投资人', desc: '达成天使投资人结局', rarity: 'rare', check: p => p.endingId === 'angel_glory' },
  { id: 'ending_teacher_legacy', name: '教师桃李满天下', desc: '达成教师桃李满天下结局', rarity: 'rare', check: p => p.endingId === 'teacher_legacy' },
  { id: 'ending_couple_70_same_day', name: '相伴七十载', desc: '达成夫妻相伴70年同日离结局', rarity: 'rare', check: p => p.endingId === 'couple_70_same_day' },
  { id: 'ending_doctor_hero_death', name: '医者仁心', desc: '达成医生救人无数自己病逝结局', rarity: 'epic', check: p => p.endingId === 'doctor_hero_death' },
  { id: 'ending_chef_empire', name: '厨师帝国', desc: '达成厨师开连锁帝国结局', rarity: 'rare', check: p => p.endingId === 'chef_empire' },
  { id: 'ending_athlete_empire', name: '奥运金牌后商业帝国', desc: '达成运动员奥运金牌后商业帝国结局', rarity: 'epic', check: p => p.endingId === 'athlete_empire' },
  { id: 'ending_billionaire', name: '亿万富翁', desc: '达成亿万富翁结局', rarity: 'legendary', check: p => p.endingId === 'billionaire' },
  { id: 'ending_vc_king', name: '风投之王', desc: '达成风投之王结局', rarity: 'legendary', check: p => p.endingId === 'vc_king' },
  { id: 'ending_business_boss', name: '商业大佬', desc: '达成商业大佬结局', rarity: 'legendary', check: p => p.endingId === 'business_boss' },
  { id: 'ending_kol_top', name: 'KOL 顶流', desc: '达成 KOL 顶流结局', rarity: 'epic', check: p => p.endingId === 'kol_top' },
  { id: 'ending_celebrity_legend', name: '名人传奇', desc: '达成名人传奇结局', rarity: 'epic', check: p => p.endingId === 'celebrity_legend' },
  { id: 'ending_crypto_empire', name: '加密帝国', desc: '达成加密帝国结局', rarity: 'mythic', check: p => p.endingId === 'crypto_empire' },
  { id: 'ending_debt_suicide', name: '负债跳楼', desc: '达成负债跳楼结局', rarity: 'rare', check: p => p.endingId === 'debt_suicide' },
  { id: 'ending_retire_after_peak', name: '功成身退', desc: '达成事业巅峰后隐退结局', rarity: 'rare', check: p => p.endingId === 'retire_after_peak' },
  { id: 'ending_bad', name: '坏结局', desc: '达成任意坏结局（破产/还债/种地/戒断/小亏）', rarity: 'common', check: p => (LIFE_ENDINGS[p.endingId] || {}).class === 'bad' },
  { id: 'ending_normal', name: '平凡收场', desc: '达成任意普通类结局', rarity: 'common', check: p => (LIFE_ENDINGS[p.endingId] || {}).class === 'normal' },
  { id: 'ending_great', name: '大成之人', desc: '达成任意大成类结局', rarity: 'legendary', check: p => (LIFE_ENDINGS[p.endingId] || {}).class === 'great' },
  // ----- 更多悲剧/离奇/科幻结局成就（至少 20 个） -----
  { id: 'ending_debt_fugitive', name: '被追杀跑路', desc: '达成被追杀跑路结局', rarity: 'uncommon', check: p => p.endingId === 'debt_fugitive' },
  { id: 'ending_sudden_death', name: '意外早逝', desc: '达成意外早逝结局', rarity: 'uncommon', check: p => p.endingId === 'sudden_death' },
  { id: 'ending_cancer_fight', name: '癌症抗争', desc: '达成癌症抗争结局', rarity: 'uncommon', check: p => p.endingId === 'cancer_fight' },
  { id: 'ending_homeless_freeze', name: '冻死街头', desc: '达成流浪汉冻死街头结局', rarity: 'uncommon', check: p => p.endingId === 'homeless_freeze' },
  { id: 'ending_gambling_ruin', name: '赌到倾家荡产', desc: '达成痴迷赌博倾家荡产结局', rarity: 'uncommon', check: p => p.endingId === 'gambling_ruin' },
  { id: 'ending_programmer_burnout', name: '996 猝死', desc: '达成程序员996猝死结局', rarity: 'uncommon', check: p => p.endingId === 'programmer_burnout' },
  { id: 'ending_dementia_forgotten', name: '痴呆被遗忘', desc: '达成痴呆晚年被遗忘结局', rarity: 'uncommon', check: p => p.endingId === 'dementia_forgotten' },
  { id: 'ending_eco_hero', name: '环保斗士', desc: '达成环保斗士改变世界后离去结局', rarity: 'rare', check: p => p.endingId === 'eco_hero' },
  { id: 'ending_war_survivor', name: '战争幸存者', desc: '达成战争幸存者创伤一生结局', rarity: 'uncommon', check: p => p.endingId === 'war_survivor' },
  { id: 'ending_artist_posthumous', name: '身后成名', desc: '达成艺术家穷困而死却后世成名结局', rarity: 'rare', check: p => p.endingId === 'artist_posthumous' },
  { id: 'ending_writer_hermit', name: '作家隐居', desc: '达成作家畅销书后隐居结局', rarity: 'uncommon', check: p => p.endingId === 'writer_hermit' },
  { id: 'ending_betrayed_all', name: '众叛亲离', desc: '达成众叛亲离结局', rarity: 'uncommon', check: p => p.endingId === 'betrayed_all' },
  { id: 'ending_space_explorer', name: '星际探险家', desc: '达成星际探险家结局', rarity: 'epic', check: p => p.endingId === 'space_explorer' },
  { id: 'ending_mind_upload', name: '意识上传', desc: '达成意识上传结局', rarity: 'epic', check: p => p.endingId === 'mind_upload' },
  { id: 'ending_mars_settler', name: '火星移民', desc: '达成火星移民结局', rarity: 'epic', check: p => p.endingId === 'mars_settler' },
  { id: 'ending_ai_merge', name: 'AI 融合', desc: '达成与人工智能合体结局', rarity: 'legendary', check: p => p.endingId === 'ai_merge' },
  { id: 'ending_time_traveler', name: '时间旅行者', desc: '达成时间旅行者结局', rarity: 'epic', check: p => p.endingId === 'time_traveler' },
  { id: 'ending_zombie_apocalypse', name: '丧尸末日', desc: '达成丧尸末日结局', rarity: 'epic', check: p => p.endingId === 'zombie_apocalypse' },
  { id: 'ending_cyborg_300', name: '赛博义体人', desc: '达成赛博朋克义体人活到300岁结局', rarity: 'epic', check: p => p.endingId === 'cyborg_300' },
  { id: 'ending_apocalypse_survivor', name: '末世幸存', desc: '达成末世幸存者结局', rarity: 'epic', check: p => p.endingId === 'apocalypse_survivor' },
  { id: 'ending_vr_addict_death', name: 'VR 沉迷至死', desc: '达成虚拟现实沉迷结局', rarity: 'rare', check: p => p.endingId === 'vr_addict_death' },
  { id: 'ending_nano_immortal', name: '纳米永生', desc: '达成纳米永生结局', rarity: 'epic', check: p => p.endingId === 'nano_immortal' },
  { id: 'ending_quantum_mad', name: '量子机发明者疯掉', desc: '达成量子计算机发明者疯掉结局', rarity: 'rare', check: p => p.endingId === 'quantum_mad' },
  { id: 'ending_clone_fusion', name: '克隆融合', desc: '达成克隆人多重人生最终融合结局', rarity: 'epic', check: p => p.endingId === 'clone_fusion' },
  { id: 'ending_space_elevator', name: '太空电梯建造者', desc: '达成太空电梯建造者结局', rarity: 'rare', check: p => p.endingId === 'space_elevator' },
  { id: 'ending_moon_base_death', name: '月球基地牺牲', desc: '达成月球基地爆炸牺牲结局', rarity: 'rare', check: p => p.endingId === 'moon_base_death' },
  { id: 'ending_cryo_awake_alone', name: '冷冻复苏孤独', desc: '达成冷冻复苏后世界巨变孤独结局', rarity: 'epic', check: p => p.endingId === 'cryo_awake_alone' },
  { id: 'ending_wasteland_leader', name: '废土领袖', desc: '达成末世游牧领袖结局', rarity: 'epic', check: p => p.endingId === 'wasteland_leader' },
  { id: 'ending_inherit_fortune', name: '继承巨款', desc: '达成突然继承巨额遗产结局', rarity: 'uncommon', check: p => p.endingId === 'inherit_fortune' },
  { id: 'ending_lottery_late', name: '晚年中奖', desc: '达成晚年中彩票逆袭结局', rarity: 'uncommon', check: p => p.endingId === 'lottery_late' },
  { id: 'ending_philanthropist_poor', name: '捐光家产', desc: '达成慈善家捐光家产安贫乐道结局', rarity: 'rare', check: p => p.endingId === 'philanthropist_poor' },
];

const ACHIEVEMENT_KEY = 'memeMaxAchievements';
const COUNTS_KEY = 'memeMaxCounts';

/** 稀有度排序权重：用于成就列表先已解锁后未解锁、再按稀有度从低到高 */
const ACHIEVEMENT_RARITY_ORDER = { common: 0, uncommon: 1, rare: 2, epic: 3, legendary: 4, mythic: 5, supreme: 6 };

function getCounts() {
  try {
    const raw = localStorage.getItem(COUNTS_KEY);
    return raw ? JSON.parse(raw) : { gamesFinished: 0, wealth1e7: 0, wealth1e8: 0, wealth1e9: 0 };
  } catch (err) { return { gamesFinished: 0, wealth1e7: 0, wealth1e8: 0, wealth1e9: 0 }; }
}

function updateCounts(netWealth) {
  const c = getCounts();
  c.gamesFinished = (c.gamesFinished || 0) + 1;
  if (Number(netWealth) >= 1e9) c.wealth1e9 = (c.wealth1e9 || 0) + 1;
  if (Number(netWealth) >= 1e8) c.wealth1e8 = (c.wealth1e8 || 0) + 1;
  if (Number(netWealth) >= 1e7) c.wealth1e7 = (c.wealth1e7 || 0) + 1;
  try { localStorage.setItem(COUNTS_KEY, JSON.stringify(c)); } catch (err) { return; }
  return c;
}

function getUnlockedAchievements() {
  try {
    const raw = localStorage.getItem(ACHIEVEMENT_KEY);
    return raw ? JSON.parse(raw) : [];
  } catch (err) { return []; }
}

function unlockAchievement(id) {
  const list = getUnlockedAchievements();
  if (list.includes(id)) return false;
  list.push(id);
  try { localStorage.setItem(ACHIEVEMENT_KEY, JSON.stringify(list)); } catch (err) { return false; }
  return true;
}

function buildAchievementPayload(s) {
  // 数值统一转为 Number，避免 undefined/字符串导致成就判定失败（如路人甲、归零等）
  return {
    netWealth: Number(getNetWealth(s)),
    fans: Number(s.fans) || 0,
    path: s.mainPath,
    endingId: s.ending,
    year: Number(s.year) || 0,
    week: Number(s.week) || 0,
    hadWindfall100: s.hadWindfall100 === true,
    hadWindfall1000: s.hadWindfall1000 === true,
    hadCatastrophe: s.hadCatastrophe === true,
    pathSaint: s.pathSaint || null,
    debt: Number(s.debt) || 0,
  };
}

/** 检查并解锁成就，返回本局新解锁的成就 id 列表 */
function checkAndUnlockAchievements(payload) {
  const before = getUnlockedAchievements().slice();
  ACHIEVEMENTS.forEach(a => {
    if (before.includes(a.id)) return;
    if (a.check(payload)) unlockAchievement(a.id);
  });
  const after = getUnlockedAchievements();
  return after.filter(id => !before.includes(id));
}

function renderAchievements() {
  const listEl = document.getElementById('achievementList');
  if (!listEl) return;
  const unlocked = getUnlockedAchievements();
  const sorted = [...ACHIEVEMENTS].sort((a, b) => {
    const uA = unlocked.includes(a.id) ? 1 : 0;
    const uB = unlocked.includes(b.id) ? 1 : 0;
    if (uB !== uA) return uB - uA; // 已解锁在前
    return (ACHIEVEMENT_RARITY_ORDER[a.rarity] ?? 0) - (ACHIEVEMENT_RARITY_ORDER[b.rarity] ?? 0); // 同组内按稀有度从低到高（common 在前）
  });
  listEl.innerHTML = sorted.map(a => {
    const unlocked_ = unlocked.includes(a.id);
    const nameStr = escapeHtml(unlocked_ ? a.name : '？？？');
    const descStr = escapeHtml(unlocked_ ? (a.desc || '') : '未解锁');
    const rawTitle = unlocked_ ? (a.desc || '') : '解锁方式：' + (a.desc || '');
    const titleStr = escapeHtml(rawTitle).replace(/"/g, '&quot;');
    return `<div class="achievement-box rarity-${a.rarity} ${unlocked_ ? 'unlocked' : 'locked'}" title="${titleStr}">
      <div class="achievement-name">${nameStr}</div>
      <div class="achievement-desc">${descStr}</div>
    </div>`;
  }).join('');
}

const HISTORY_KEY = 'memeMaxHistory';
const HISTORY_MAX = 30;

function saveGameHistory(record) {
  try {
    const list = getGameHistory();
    record.id = Date.now();
    list.unshift(record);
    if (list.length > HISTORY_MAX) list.length = HISTORY_MAX;
    localStorage.setItem(HISTORY_KEY, JSON.stringify(list));
  } catch (err) { /* quota or disabled */ }
}

function getGameHistory() {
  try {
    const raw = localStorage.getItem(HISTORY_KEY);
    return raw ? JSON.parse(raw) : [];
  } catch (err) { return []; }
}

function updateUI() {
  const s = game.state;
  if (!s) return;
  const netW = getNetWealth(s);
  const wealthEl = document.getElementById('dispWealth');
  wealthEl.textContent = formatU(netW);
  if (netW < 0) wealthEl.classList.add('negative'); else wealthEl.classList.remove('negative');
  document.getElementById('dispFans').textContent = formatU(s.fans);
  document.getElementById('dispPath').textContent = (PATHS.find(p => p.id === s.mainPath) || {}).name || s.mainPath;
  const playerIdEl = document.getElementById('dispPlayerId');
  if (playerIdEl) {
    const pid = (s.playerId || '').trim();
    playerIdEl.textContent = pid ? 'ID: ' + pid : '—';
    playerIdEl.setAttribute('data-empty', pid ? 'false' : 'true');
  }
  const timeEl = document.getElementById('dispTime');
  if (timeEl) timeEl.textContent = `第 ${s.year + 1}/${MAX_YEARS} 年 ${s.week + 1} 月`;
  document.getElementById('marketPhase').textContent = 
    game.marketPhase === 'bull' ? '🐂 牛市' : game.marketPhase === 'bear' ? '🐻 熊市' : '➡️ 横盘';
  renderChart();
  renderLog();
}

function formatU(n) {
  if (n >= 1e6) return (n / 1e6).toFixed(2) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(1) + 'K';
  return Math.floor(n).toString();
}

function renderChart() {
  const line = document.getElementById('chartLine');
  if (!line || !game.marketHistory.length) return;
  const h = game.marketHistory;
  const len = h.length;
  const min = Math.min(...h);
  const max = Math.max(...h) || 1;
  const range = max - min || 1;
  const pts = h.map((v, i) => `${(i / (len - 1 || 1)) * 100}% ${100 - ((v - min) / range) * 80}%`).join(', ');
  line.style.clipPath = `polygon(0 100%, ${pts}, 100% 100%)`;
}

function renderPathList() {
  const el = document.getElementById('pathList');
  if (!el) return;
  const s = game.state;
  if (!s) return;
  const p = PATHS.find(x => x.id === s.mainPath) || PATHS[0];
  el.innerHTML = `<div class="path-item current"><span>${p.icon} ${p.name}</span></div>`;
}

function bindSpeedSelect() {
  const el = document.getElementById('speedSelect');
  if (!el) return;
  el.addEventListener('change', () => {
    const speed = Math.max(1, Math.min(100, parseInt(el.value, 10) || 1));
    game.speed = speed;
    if (!game.paused) startTickLoop();
  });
}

function bindPause() {
  const btn = document.getElementById('btnPause');
  if (!btn) return;
  btn.addEventListener('click', () => {
    if (game.paused) {
      game.paused = false;
      startTickLoop();
      btn.textContent = '⏸ 暂停';
    } else {
      game.paused = true;
      if (game.tickInterval) { clearInterval(game.tickInterval); game.tickInterval = null; }
      btn.textContent = '▶ 继续';
    }
  });
}

function openLastRunModal() {
  const r = game.lastRunSummary;
  if (!r) return;
  document.getElementById('lastRunTitle').textContent = r.title || '上一局';
  const metaParts = [formatU(r.wealth) + ' U', '第 ' + (r.year + 1) + ' 年 ' + (r.week + 1) + ' 月', (PATHS.find(p => p.id === r.path) || {}).name || r.path];
  if (r.playerId) metaParts.unshift('ID: ' + r.playerId);
  document.getElementById('lastRunMeta').textContent = metaParts.join(' · ');
  document.getElementById('lastRunStory').textContent = r.story || '';
  const achEl = document.getElementById('lastRunAch');
  achEl.innerHTML = (r.unlockedThisRun && r.unlockedThisRun.length) ? '本局解锁成就：' + r.unlockedThisRun.map(a => a.name).join('、') : '';
  const logEl = document.getElementById('lastRunLog');
  logEl.innerHTML = (r.eventLog && r.eventLog.length) ? r.eventLog.map(e => '<div class="log-line ' + (e.type || '') + '">' + escapeHtml(e.time || '') + ' ' + escapeHtml(e.text || '') + '</div>').join('') : '<p>无日志</p>';
  document.getElementById('lastRunOverlay').classList.add('show');
}

function bindLastRun() {
  document.getElementById('btnLastRun')?.addEventListener('click', openLastRunModal);
  document.getElementById('lastRunClose')?.addEventListener('click', () => document.getElementById('lastRunOverlay')?.classList.remove('show'));
  document.getElementById('lastRunOverlay')?.addEventListener('click', (ev) => { if (ev.target.id === 'lastRunOverlay') ev.target.classList.remove('show'); });
}

/** 仅收起结局弹层，留在本局界面，显示「查看上一局」「再来一局」栏 */
function dismissEndingOnly() {
  document.getElementById('endingScreen').classList.remove('show');
  const bar = document.getElementById('afterEndBar');
  if (bar) bar.style.display = 'flex';
  const btnPause = document.getElementById('btnPause');
  if (btnPause) btnPause.style.display = 'none';
}

/** 进入开局设置页（隐藏结局栏、显示开始页） */
function goToStartScreen() {
  document.getElementById('endingScreen').classList.remove('show');
  document.getElementById('startScreen').classList.remove('hidden');
  const bar = document.getElementById('afterEndBar');
  if (bar) bar.style.display = 'none';
  const btnLastRun = document.getElementById('btnLastRun');
  if (btnLastRun) btnLastRun.style.display = game.lastRunSummary ? '' : 'none';
}

function bindRestart() {
  document.getElementById('btnRestart').addEventListener('click', () => {
    goToStartScreen();
    game.state = null;
    game.running = false;
    const btnPause = document.getElementById('btnPause');
    if (btnPause) btnPause.style.display = 'none';
  });
  document.getElementById('btnEndingDismiss')?.addEventListener('click', () => {
    dismissEndingOnly();
  });
  document.getElementById('btnRestartFromBar')?.addEventListener('click', () => {
    goToStartScreen();
    game.state = null;
    game.running = false;
    const btnPause = document.getElementById('btnPause');
    if (btnPause) btnPause.style.display = 'none';
  });
  document.getElementById('btnLastRunFromBar')?.addEventListener('click', openLastRunModal);
}

function openHistoryModal() {
  const overlay = document.getElementById('historyOverlay');
  const listEl = document.getElementById('historyList');
  const detailEl = document.getElementById('historyDetail');
  if (!overlay || !listEl) return;
  detailEl.style.display = 'none';
  listEl.style.display = '';
  const list = getGameHistory();
  listEl.innerHTML = list.length === 0
    ? '<p class="history-item" style="cursor:default;">暂无历史对局</p>'
    : list.map(r => {
        const pathName = (PATHS.find(p => p.id === r.path) || {}).name || r.path || '-';
        const metaParts = [formatU(r.wealth != null ? r.wealth : 0) + ' U', '第' + ((r.year != null ? r.year : 0) + 1) + '年' + ((r.week != null ? r.week : 0) + 1) + '月', pathName];
        if (r.playerId) metaParts.unshift('ID: ' + escapeHtml(r.playerId));
        return `<div class="history-item" data-id="${r.id}">
          <span class="hi-title">${escapeHtml(r.title || '未命名')}</span>
          <div class="hi-meta">${metaParts.join(' · ')}</div>
        </div>`;
      }).join('');
  listEl.querySelectorAll('.history-item[data-id]').forEach(el => {
    el.addEventListener('click', () => showHistoryDetail(Number(el.dataset.id)));
  });
  overlay.classList.add('show');
}

function showHistoryDetail(id) {
  const list = getGameHistory();
  const r = list.find(x => x.id === id);
  const listEl = document.getElementById('historyList');
  const detailEl = document.getElementById('historyDetail');
  const titleEl = document.getElementById('historyDetailTitle');
  const metaEl = document.getElementById('historyDetailMeta');
  const logEl = document.getElementById('historyDetailLog');
  if (!r || !detailEl) return;
  listEl.style.display = 'none';
  detailEl.style.display = 'block';
  titleEl.textContent = r.title || '未命名';
  const detailMetaParts = [formatU(r.wealth != null ? r.wealth : 0) + ' U', '粉丝 ' + formatU(r.fans || 0), '第 ' + ((r.year != null ? r.year : 0) + 1) + ' 年 ' + ((r.week != null ? r.week : 0) + 1) + ' 月'];
  if (r.playerId) detailMetaParts.unshift('ID: ' + r.playerId);
  metaEl.textContent = detailMetaParts.join(' · ');
  const storyEl = document.getElementById('historyDetailStory');
  if (storyEl) {
    storyEl.textContent = r.story || '';
    storyEl.style.display = (r.story ? 'block' : 'none');
  }
  const log = (r.eventLog || []);
  logEl.innerHTML = log.length === 0
    ? '<p>无日志</p>'
    : log.map(e => `<div class="log-line ${e.type || ''}">${escapeHtml(e.time || '')} ${escapeHtml(e.text || '')}</div>`).join('');
}

function escapeHtml(s) {
  const div = document.createElement('div');
  div.textContent = s;
  return div.innerHTML;
}

function bindHistoryUI() {
  const overlay = document.getElementById('historyOverlay');
  document.getElementById('btnHistory')?.addEventListener('click', openHistoryModal);
  document.getElementById('historyClose')?.addEventListener('click', () => overlay?.classList.remove('show'));
  document.getElementById('historyDetailBack')?.addEventListener('click', () => {
    document.getElementById('historyDetail').style.display = 'none';
    document.getElementById('historyList').style.display = '';
  });
}

function initStartForm() {
  const form = document.getElementById('startForm');
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    const capital = parseInt(document.getElementById('initCapital').value, 10) || 1000;
    const traits = {
      luck: parseFloat(document.getElementById('initLuck').value) || 0.5,
      social: parseFloat(document.getElementById('initSocial').value) || 0.5,
      rationality: parseFloat(document.getElementById('initRationality').value) || 0.5,
      strategy: parseFloat(document.getElementById('initStrategy').value) || 0.5,
      riskPreference: parseFloat(document.getElementById('initRisk').value) || 0.5,
    };
    document.getElementById('startScreen').classList.add('hidden');
    startNewGame(capital, traits);
  });
}

window.addEventListener('DOMContentLoaded', () => {
  initStartForm();
  bindSpeedSelect();
  bindPause();
  bindRestart();
  bindHistoryUI();
  bindLastRun();
  renderAchievements();
});

window.game = game;
window.startNewGame = startNewGame;
